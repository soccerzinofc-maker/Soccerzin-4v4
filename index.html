<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOCCERZIN 4V4 - PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #052e16; touch-action: none; font-family: sans-serif; }
        canvas { display: block; background: #14532d; }
        
        #orientacao-aviso {
            display: none; position: fixed; inset: 0; background: #000; z-index: 999;
            color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        @media (orientation: portrait) { #orientacao-aviso { display: flex; } }

        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        #hud-controls { display: none; }

        .btn-game { 
            position: absolute; pointer-events: auto; width: 85px; height: 85px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 900; color: white; border: 3px solid rgba(255,255,255,0.8); z-index: 20;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3), inset 0 2px 10px rgba(255,255,255,0.2);
            transition: transform 0.05s;
        }
        .btn-game:active { transform: translateY(4px); }
        
        #kickBtn { background: linear-gradient(145deg, #ea580c, #9a3412); }
        #passBtn { background: linear-gradient(145deg, #2563eb, #1e40af); }

        #joy-base { position: absolute; width: 125px; height: 125px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; width: 45%; height: 45%; background: radial-gradient(circle, #fff, #cbd5e1); border-radius: 50%; top: 27.5%; left: 27.5%; pointer-events: none; }

        /* CHAT SYSTEM */
        #chat-container { position: absolute; top: 80px; left: 20px; width: 250px; height: 150px; background: rgba(0,0,0,0.5); border-radius: 10px; pointer-events: auto; display: none; flex-direction: column; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-msgs { flex: 1; overflow-y: auto; color: white; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 1px black; }
        #chat-input-row { display: flex; gap: 5px; }
        #chat-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 5px; flex: 1; font-size: 12px; }
        #chat-send { background: #22c55e; color: black; font-weight: bold; padding: 4px 10px; border-radius: 5px; font-size: 12px; }
        #btn-toggle-chat { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; border-radius: 10px; padding: 10px; pointer-events: auto; font-size: 14px; font-weight: bold; border: 1px solid white; }

        .editing { border: 4px dashed #facc15 !important; filter: brightness(1.2); }
        .selected-edit { border: 6px solid #4ade80 !important; box-shadow: 0 0 20px #4ade80; }

        #edit-panel { 
            display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            pointer-events: auto; z-index: 100; width: 300px;
        }

        #goal-container { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 200; pointer-events: none; }
        #goal-title { color: #facc15; font-size: 100px; font-weight: 900; text-shadow: 0 10px 20px rgba(0,0,0,0.8); margin: 0; animation: goalAnim 0.5s infinite alternate; }
        @keyframes goalAnim { 0% { transform: scale(1) rotate(-2deg); } 100% { transform: scale(1.1) rotate(2deg); } }
    </style>
</head>
<body>

<div id="orientacao-aviso">üì±<h2 class="text-xl font-bold mt-4 italic">VIRE O CELULAR</h2></div>

<canvas id="game"></canvas>

<div id="goal-container">
    <h1 id="goal-title">GOL!</h1>
    <p id="goal-nick" class="text-white text-3xl font-black italic shadow-lg uppercase tracking-wider drop-shadow-md"></p>
</div>

<div id="edit-panel" class="text-white">
    <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-green-400 italic text-sm">HUD EDITOR</h3>
    </div>
    <input type="range" id="size-slider" min="40" max="180" oninput="updateItemSize()" class="w-full accent-green-500">
    <input type="range" id="zoom-slider" min="0.5" max="1.5" step="0.05" oninput="updateZoom()" class="w-full mt-2 accent-green-500">
    <button onclick="toggleHudEdit()" class="mt-4 bg-green-500 text-black px-6 py-2 rounded-xl font-black w-full text-xs">SALVAR</button>
</div>

<div class="ui-layer">
    <div id="scoreboard" class="hidden absolute top-5 left-1/2 -translate-x-1/2 bg-black/80 px-6 py-1 rounded-full border-2 border-white flex gap-6 text-2xl font-black text-white italic">
        <div id="timer" class="text-yellow-400 border-r border-white/20 pr-4">05:00</div>
        <span class="text-blue-500" id="scoreA">0</span><span class="text-red-500" id="scoreV">0</span>
    </div>

    <div id="hud-controls">
        <div id="btn-toggle-chat" onclick="toggleChat()">CHAT</div>
        <div id="chat-container">
            <div id="chat-msgs"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-input" placeholder="Mensagem...">
                <button id="chat-send" onclick="sendChatMessage()">ENVIAR</button>
            </div>
        </div>

        <div id="joy-base" style="bottom: 40px; left: 40px;"><div id="joy-stick"></div></div>
        <div id="kickBtn" class="btn-game" style="bottom: 40px; right: 130px;">CHUTE</div>
        <div id="passBtn" class="btn-game" style="bottom: 40px; right: 30px;">PASSE</div>
    </div>

    <div id="lobby" class="absolute inset-0 bg-black/95 flex flex-col items-center justify-center pointer-events-auto p-4">
        <h1 class="text-white text-7xl font-black italic mb-2">SOCCERZIN <span class="text-green-500">4V4</span></h1>
        <input type="text" id="playerNick" class="bg-white/5 border border-white/10 text-white px-4 py-4 rounded-2xl mb-6 w-72 text-center font-bold text-xl" placeholder="NICKNAME" maxlength="12">
        <div class="flex gap-4 mb-8">
            <button onclick="joinGame('azul')" class="bg-blue-600 text-white px-10 py-5 rounded-2xl font-black text-xl shadow-lg hover:scale-105 transition">AZUL</button>
            <button onclick="joinGame('vermelho')" class="bg-red-600 text-white px-10 py-5 rounded-2xl font-black text-xl shadow-lg hover:scale-105 transition">VERMELHO</button>
        </div>
        
        <div class="flex gap-4">
            <button onclick="toggleHudEdit()" class="text-yellow-500 border border-yellow-500/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-yellow-500/10 transition">‚öôÔ∏è HUD</button>
            <button onclick="toggleFullScreen()" class="text-white border border-white/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">‚õ∂ TELA CHEIA</button>
        </div>
    </div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const FIELD_W = 2200, FIELD_H = 1200;
const GOAL_H_HALF = 160; 
const GOAL_DEPTH = 80;

let isEditing = false, dragElement = null, selectedElement = null;
let gameZoom = 0.75; 
let particles = [];
let timeLeft = 300; // 5 minutos em segundos

// SISTEMA DE CHAT
function toggleChat() {
    const chat = document.getElementById('chat-container');
    chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
}

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(msg !== "") {
        const msgsDiv = document.getElementById('chat-msgs');
        const p = document.createElement('div');
        p.innerHTML = `<strong>${player.nick}:</strong> ${msg}`;
        msgsDiv.appendChild(p);
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
        input.value = "";
    }
}

// TEMPORIZADOR
function startTimer() {
    setInterval(() => {
        if(player.time && timeLeft > 0) {
            timeLeft--;
            let mins = Math.floor(timeLeft / 60);
            let secs = timeLeft % 60;
            document.getElementById('timer').innerText = 
                `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            
            if(timeLeft === 0) {
                timeLeft = 300; // Reset 5 min
                resetPositions();
            }
        }
    }, 1000);
}
startTimer();

// SOM
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    
    if(type === 'kick') {
        osc.frequency.setValueAtTime(120, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    } else if (type === 'post') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime); // Som mais suave
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    } else if (type === 'goal') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
    }
    osc.start(); osc.stop(audioCtx.currentTime + (type==='goal'?1.0:0.5));
}

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
    else if (document.exitFullscreen) document.exitFullscreen();
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

let player = { x: 0, y: 0, vx: 0, vy: 0, r: 24, time: '', nick: '' };
let ball = { x: FIELD_W/2, y: FIELD_H/2, vx: 0, vy: 0, r: 15, visible: true }; 
let score = { azul: 0, verm: 0 }, joy = { active: false, angle: 0, force: 0, id: null };
let isGoalProcess = false;

function toggleHudEdit() {
    isEditing = !isEditing;
    document.getElementById('lobby').style.display = isEditing ? 'none' : 'flex';
    document.getElementById('edit-panel').style.display = isEditing ? 'block' : 'none';
    document.getElementById('hud-controls').style.display = (isEditing || player.time) ? 'block' : 'none';
    if(!isEditing) selectedElement = null;
    ['joy-base', 'kickBtn', 'passBtn'].forEach(id => {
        const el = document.getElementById(id);
        el.classList.toggle('editing', isEditing);
        el.classList.remove('selected-edit');
    });
}

function updateItemSize() {
    if(!selectedElement) return;
    const val = document.getElementById('size-slider').value + 'px';
    selectedElement.style.width = val; selectedElement.style.height = val;
}
function updateZoom() { gameZoom = parseFloat(document.getElementById('zoom-slider').value); }

window.addEventListener('touchstart', (e) => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const t = e.changedTouches[0];
    if(isEditing) {
        ['joy-base', 'kickBtn', 'passBtn'].forEach(id => {
            const el = document.getElementById(id); const r = el.getBoundingClientRect();
            if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) {
                dragElement = el; selectedElement = el;
                ['joy-base', 'kickBtn', 'passBtn'].forEach(i => document.getElementById(i).classList.remove('selected-edit'));
                el.classList.add('selected-edit');
                document.getElementById('size-slider').value = parseInt(el.style.width) || 85;
            }
        });
    } else if(player.time) {
        const r = document.getElementById('joy-base').getBoundingClientRect();
        if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) { joy.id = t.identifier; joy.active = true; }
    }
});

window.addEventListener('touchmove', (e) => {
    if(isEditing && dragElement) {
        const t = e.touches[0];
        dragElement.style.left = (t.clientX - dragElement.offsetWidth/2) + 'px';
        dragElement.style.top = (t.clientY - dragElement.offsetHeight/2) + 'px';
    } else if(joy.active) {
        for(let touch of e.touches) if(touch.identifier === joy.id) {
            const r = document.getElementById('joy-base').getBoundingClientRect();
            const dx = touch.clientX - (r.left + r.width/2), dy = touch.clientY - (r.top + r.height/2);
            const dist = Math.min(r.width/2, Math.sqrt(dx*dx + dy*dy));
            joy.angle = Math.atan2(dy, dx); joy.force = dist / (r.width/2);
            document.getElementById('joy-stick').style.transform = `translate(${Math.cos(joy.angle)*dist}px, ${Math.sin(joy.angle)*dist}px)`;
        }
    }
});

window.addEventListener('touchend', (e) => {
    dragElement = null;
    for(let t of e.changedTouches) if(t.identifier === joy.id) { joy.active = false; joy.force = 0; document.getElementById('joy-stick').style.transform = `translate(0,0)`; }
});

function applyKick(f) {
    if(isEditing) return; 
    const dx = ball.x - player.x, dy = ball.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < 75) { 
        ball.vx = (dx/dist)*f; ball.vy = (dy/dist)*f; 
        playSound('kick');
    }
}

document.getElementById('kickBtn').addEventListener('touchstart', (e) => { e.preventDefault(); applyKick(16); });
document.getElementById('passBtn').addEventListener('touchstart', (e) => { e.preventDefault(); applyKick(9); });

function joinGame(team) {
    player.nick = document.getElementById('playerNick').value.trim() || "CRAQUE";
    player.time = team;
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('hud-controls').style.display = 'block';
    document.getElementById('scoreboard').style.display = 'flex';
    resetPositions();
}

function resetPositions() {
    ball.x = FIELD_W/2; ball.y = FIELD_H/2; ball.vx = 0; ball.vy = 0;
    player.x = player.time === 'azul' ? 400 : FIELD_W - 400; 
    player.y = FIELD_H/2; player.vx = 0; player.vy = 0;
}

function triggerGoal(scorer) {
    playSound('goal');
    document.getElementById('goal-nick').innerText = scorer;
    document.getElementById('goal-container').style.display = 'block';
    
    for(let i=0; i<80; i++) {
        particles.push({
            x: canvas.width/2, y: canvas.height/2,
            vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
            life: 1.0, color: `hsl(${Math.random()*360}, 100%, 50%)`
        });
    }

    setTimeout(() => {
        document.getElementById('goal-container').style.display = 'none';
        isGoalProcess = false;
        resetPositions();
    }, 2500);
}

function drawModernGoal(ctx, x, side) {
    const topY = FIELD_H/2 - GOAL_H_HALF;
    const botY = FIELD_H/2 + GOAL_H_HALF;
    const backX = x + (side * GOAL_DEPTH);
    ctx.lineWidth = 4; ctx.lineJoin = "round";
    ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=topY; i<=botY; i+=15) { ctx.moveTo(x, i); ctx.lineTo(backX, i); }
    for(let i=0; i<=GOAL_DEPTH; i+=15) { 
        let currentX = x + (side * i); ctx.moveTo(currentX, topY); ctx.lineTo(currentX, botY); 
    }
    ctx.stroke();
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(backX, topY); ctx.lineTo(backX, botY);
    ctx.moveTo(x, topY); ctx.lineTo(backX, topY);
    ctx.moveTo(x, botY); ctx.lineTo(backX, botY);
    ctx.stroke();
    ctx.fillStyle = "#eee";
    ctx.beginPath(); ctx.arc(x, topY, 6, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x, botY, 6, 0, Math.PI*2); ctx.fill();
}

function checkPostCollision(entity) {
    const topPost = FIELD_H/2 - GOAL_H_HALF;
    const botPost = FIELD_H/2 + GOAL_H_HALF;
    const posts = [{x:0, y:topPost}, {x:0, y:botPost}, {x:FIELD_W, y:topPost}, {x:FIELD_W, y:botPost}];

    posts.forEach(p => {
        let dx = entity.x - p.x, dy = entity.y - p.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < entity.r + 6) { 
            let angle = Math.atan2(dy, dx);
            if(entity === ball) {
                playSound('post'); 
                // POT√äNCIA FRAQUINHA NA TRAVE (Reduzida de 10 para 3)
                entity.vx = Math.cos(angle) * 3.5;
                entity.vy = Math.sin(angle) * 3.5;
            } else {
                entity.x = p.x + Math.cos(angle) * (entity.r + 6);
                entity.y = p.y + Math.sin(angle) * (entity.r + 6);
            }
        }
    });
}

function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if(particles.length > 0) {
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 6, 6);
            if(p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1.0;
    }

    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(gameZoom, gameZoom);
    ctx.translate(-player.x, -player.y);

    // CH√ÉO EXTENDIDO (para o jogador sair do campo)
    ctx.fillStyle = "#14532d"; ctx.fillRect(-1000, -1000, FIELD_W+2000, FIELD_H+2000);
    ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 5; ctx.strokeRect(0, 0, FIELD_W, FIELD_H);
    ctx.beginPath(); ctx.moveTo(FIELD_W/2, 0); ctx.lineTo(FIELD_W/2, FIELD_H); ctx.stroke();
    ctx.beginPath(); ctx.arc(FIELD_W/2, FIELD_H/2, 130, 0, Math.PI*2); ctx.stroke();

    drawModernGoal(ctx, 0, -1);
    drawModernGoal(ctx, FIELD_W, 1);

    if(player.time) {
        if(!isEditing) {
            player.vx += Math.cos(joy.angle) * joy.force * 0.8;
            player.vy += Math.sin(joy.angle) * joy.force * 0.8;
            player.vx *= 0.88; player.vy *= 0.88;
            player.x += player.vx; player.y += player.vy;
            
            // JOGADOR SAINDO DO CAMPO: Removi as travas de parede do player.
            // Apenas trava nos limites externos do cen√°rio se quiser, mas deixei livre conforme pedido.
        }
        checkPostCollision(player);

        // BOLA
        ball.x += ball.vx; ball.y += ball.vy; ball.vx *= 0.985; ball.vy *= 0.985;
        
        // COLIS√ÉO JOGADOR x BOLA
        let dx = ball.x - player.x, dy = ball.y - player.y, dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < player.r + ball.r) { 
            let ang = Math.atan2(dy, dx);
            let overlap = (player.r + ball.r) - dist;
            ball.x += Math.cos(ang) * overlap;
            ball.y += Math.sin(ang) * overlap;
            player.x -= Math.cos(ang) * (overlap * 0.5); 
            player.y -= Math.sin(ang) * (overlap * 0.5);
            ball.vx += Math.cos(ang)*0.6; ball.vy += Math.sin(ang)*0.6;
        }

        checkPostCollision(ball);

        // PAREDES BOLA (RESISTENTE - BOLA N√ÉO SAI)
        if(ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.8; }
        if(ball.y > FIELD_H - ball.r) { ball.y = FIELD_H - ball.r; ball.vy *= -0.8; }

        if(ball.x < ball.r || ball.x > FIELD_W - ball.r) {
            let inGoalY = ball.y > (FIELD_H/2 - GOAL_H_HALF) && ball.y < (FIELD_H/2 + GOAL_H_HALF);
            if(inGoalY) {
                if(!isGoalProcess) {
                    isGoalProcess = true;
                    if(ball.x < FIELD_W/2) score.verm++; else score.azul++;
                    document.getElementById('scoreV').innerText = score.verm;
                    document.getElementById('scoreA').innerText = score.azul;
                    triggerGoal(player.nick);
                }
                if(ball.x < -GOAL_DEPTH + ball.r) { ball.x = -GOAL_DEPTH + ball.r; ball.vx *= -0.5; }
                if(ball.x > FIELD_W + GOAL_DEPTH - ball.r) { ball.x = FIELD_W + GOAL_DEPTH - ball.r; ball.vx *= -0.5; }
            } else {
                if(ball.x < ball.r) { ball.x = ball.r; ball.vx *= -0.8; }
                else { ball.x = FIELD_W - ball.r; ball.vx *= -0.8; }
                if(Math.abs(ball.vx) > 2) playSound('kick');
            }
        }

        ctx.shadowBlur = 15; ctx.shadowColor = "rgba(0,0,0,0.4)";
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "#111"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(ball.x-ball.r, ball.y); ctx.lineTo(ball.x+ball.r, ball.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ball.x, ball.y-ball.r); ctx.lineTo(ball.x, ball.y+ball.r); ctx.stroke();

        ctx.fillStyle = player.time === 'azul' ? '#2563eb' : '#dc2626';
        ctx.shadowBlur = 10; ctx.shadowColor = player.time === 'azul' ? '#2563eb' : '#dc2626';
        ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
        
        ctx.fillStyle = "white"; ctx.font = "900 18px Arial"; ctx.textAlign = "center";
        ctx.fillText(player.nick, player.x, player.y - 40);
    }

    ctx.restore();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>