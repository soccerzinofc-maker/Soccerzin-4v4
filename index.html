<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOCCERZIN 4V4 - ZERO DELAY V4 (TURBO)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* OTIMIZA√á√ÉO MAXIMA */
        body { margin: 0; overflow: hidden; background: #0b1e11; touch-action: none; font-family: sans-serif; overscroll-behavior: none; user-select: none; -webkit-user-select: none; }
        canvas { display: block; background: #1a4d2e; will-change: transform; transform: translateZ(0); } /* Acelera√ß√£o de Hardware */
        
        #orientacao-aviso { display: none; position: fixed; inset: 0; background: #000; z-index: 999; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        @media (orientation: portrait) { #orientacao-aviso { display: flex; } }

        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        #hud-controls { display: none; width: 100%; height: 100%; pointer-events: none; }

        .btn-game { 
            position: absolute; pointer-events: auto; width: 85px; height: 85px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 900; color: white; border: 3px solid rgba(255,255,255,0.5); z-index: 20;
            background: rgba(0,0,0,0.3); /* Removido gradiente pesado */
        }
        .btn-game:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        
        #kickBtn { display: none; background: rgba(234, 88, 12, 0.8); }
        #passBtn { display: none; background: rgba(37, 99, 235, 0.8); }

        #joy-base { 
            position: absolute; width: 125px; height: 125px; 
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); 
            border-radius: 50%; pointer-events: auto; display: none; 
        }
        #joy-stick { position: absolute; width: 45%; height: 45%; background: rgba(255,255,255,0.8); border-radius: 50%; top: 27.5%; left: 27.5%; pointer-events: none; }

        #top-left-controls { position: absolute; top: 20px; left: 20px; display: flex; gap: 8px; pointer-events: auto; flex-wrap: wrap; max-width: 300px; }
        .btn-hud-corner { background: rgba(0,0,0,0.6); color: white; border-radius: 8px; padding: 6px 10px; font-size: 12px; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; }

        #chat-container { position: absolute; top: 80px; left: 20px; width: 250px; height: 150px; background: rgba(0,0,0,0.5); border-radius: 10px; pointer-events: auto; display: none; flex-direction: column; padding: 10px; }
        #chat-msgs { flex: 1; overflow-y: auto; color: white; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 0 #000; }
        #chat-input-row { display: flex; gap: 5px; }
        #chat-input { background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; padding: 4px; border-radius: 5px; flex: 1; font-size: 12px; }
        
        .lobby-wrapper { display: flex; flex-direction: column; height: 100vh; padding: 10px; box-sizing: border-box; }
        .lobby-content { flex: 1; overflow-y: auto; }
        
        .menu-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0f172a; }
        .team-column { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; padding: 5px; width: 30%; height: 100%; overflow-y: auto; min-height: 150px; }
        
        .player-card { background: rgba(255,255,255,0.05); margin-bottom: 3px; padding: 5px; border-radius: 3px; font-size: 11px; color: white; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .admin-options { display: flex; flex-direction: column; gap: 2px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); }
        .admin-row { display: flex; gap: 2px; width: 100%; }
        .admin-btn { flex: 1; padding: 4px; font-size: 9px; font-weight: bold; border-radius: 3px; cursor: pointer; text-align: center; color: white; }

        #goal-container { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 200; pointer-events: none; }
        #goal-title { color: #facc15; font-size: 80px; font-weight: 900; margin: 0; text-shadow: 2px 2px 0 #000; }
        
        #ingame-modal { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; pointer-events: auto; flex-direction: column; align-items: center; justify-content: center; }
        #network-status { position: absolute; bottom: 5px; left: 5px; color: #ffff00; font-size: 10px; z-index: 999; font-family: monospace; text-shadow: 1px 1px 0 #000; }
        
        .editing { border: 2px dashed #facc15 !important; }
        #edit-panel { display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: #111; padding: 10px; border-radius: 10px; z-index: 100; width: 280px; pointer-events: auto; color: white; }
    </style>
</head>
<body>

<div id="orientacao-aviso">üì±<h2 class="text-xl font-bold mt-4">VIRE O CELULAR</h2></div>
<div id="network-status">Desconectado</div>

<canvas id="game"></canvas>

<div id="goal-container">
    <h1 id="goal-title">GOL!</h1>
    <p id="goal-nick" class="text-white text-3xl font-black italic uppercase tracking-wider"></p>
</div>

<div id="edit-panel">
    <h3 class="font-bold text-center mb-2 text-sm">HUD EDITOR</h3>
    <input type="range" id="size-slider" min="40" max="180" oninput="updateItemSize()" class="w-full">
    <button onclick="toggleHudEdit()" class="mt-4 bg-green-600 w-full py-1 rounded text-xs font-bold">SALVAR</button>
</div>

<div id="ingame-modal" class="text-white">
    <h2 class="text-2xl font-black italic mb-4 text-green-500">PAUSA / MENU</h2>
    <div id="admin-game-controls" class="flex flex-col gap-3 mb-4 w-64" style="display: none;">
        <button onclick="resetMatch()" class="bg-yellow-600 py-2 rounded font-bold">üîÑ RESETAR</button>
        <button onclick="togglePause()" id="btn-pause" class="bg-blue-600 py-2 rounded font-bold">‚è∏ PAUSAR</button>
        <button onclick="cancelMatch()" class="bg-red-700 py-2 rounded font-bold">‚ùå ENCERRAR</button>
    </div>
    <button onclick="toggleIngameManager()" class="bg-white/20 px-8 py-2 rounded font-bold border border-white/20">FECHAR</button>
</div>

<div class="ui-layer">
    <div id="scoreboard" class="hidden absolute top-2 left-1/2 -translate-x-1/2 bg-black/60 px-4 py-1 rounded-full border border-white/20 flex gap-4 text-xl font-black text-white italic">
        <div id="timer" class="text-yellow-400">05:00</div>
        <span class="text-blue-500" id="scoreA">0</span><span class="text-gray-400">-</span><span class="text-red-500" id="scoreV">0</span>
    </div>

    <div id="hud-controls">
        <div id="top-left-controls">
            <div class="btn-hud-corner" onclick="toggleChat()">üí¨ CHAT</div>
            <div class="btn-hud-corner" onclick="toggleIngameManager()">‚öôÔ∏è MENU</div>
        </div>
        
        <div id="chat-container">
            <div id="chat-msgs"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-input" placeholder="...">
                <button onclick="sendChatMessage()" class="bg-green-600 text-white px-2 rounded text-xs font-bold">OK</button>
            </div>
        </div>

        <div id="joy-base" style="bottom: 40px; left: 40px;"><div id="joy-stick"></div></div>
        <div id="kickBtn" class="btn-game" style="bottom: 40px; right: 130px;">CHUTE</div>
        <div id="passBtn" class="btn-game" style="bottom: 40px; right: 30px;">PASSE</div>
    </div>

    <div id="lobby" class="absolute inset-0 bg-slate-900 text-white pointer-events-auto">
        <div id="screen-main" class="menu-screen">
            <h1 class="text-5xl font-black italic mb-2 text-center">SOCCERZIN <span class="text-green-500">V4</span></h1>
            <p class="text-[10px] text-gray-400 mb-6 font-mono">NO LAG / NO SHADOWS</p>
            <input type="text" id="playerNick" class="bg-white/10 border border-white/20 text-white px-4 py-3 rounded mb-4 w-64 text-center font-bold" placeholder="SEU NICK" maxlength="10">
            <button onclick="goToRoomMenu()" class="bg-green-600 text-black px-8 py-4 rounded font-black text-xl hover:scale-105 transition w-64">JOGAR</button>
            <div class="flex gap-2 mt-4">
                <button onclick="toggleHudEdit()" class="text-xs text-yellow-500 border border-yellow-500/30 px-3 py-1 rounded">EDITAR HUD</button>
                <button onclick="toggleFullScreen()" class="text-xs text-white border border-white/30 px-3 py-1 rounded">TELA CHEIA</button>
            </div>
        </div>

        <div id="screen-room-select" class="menu-screen hidden">
            <h2 class="text-3xl font-black italic mb-6">SALAS</h2>
            <div class="flex gap-4">
                <button onclick="createRoom()" class="bg-blue-600 w-32 h-32 rounded font-bold text-lg shadow-lg">CRIAR</button>
                <div class="bg-white/5 w-40 h-32 rounded border border-white/10 flex flex-col items-center justify-center p-2">
                    <input type="text" id="roomCodeInput" class="w-full bg-black/50 border border-white/20 rounded p-1 text-center mb-2 uppercase text-sm" placeholder="C√ìDIGO" maxlength="6">
                    <button onclick="joinRoom()" class="bg-green-600 w-full py-1 rounded font-bold text-sm">ENTRAR</button>
                </div>
            </div>
            <button onclick="backToMain()" class="mt-8 text-white/50 text-sm">VOLTAR</button>
            <p id="error-msg" class="text-red-500 text-xs mt-2 font-bold"></p>
        </div>

        <div id="screen-room-lobby" class="menu-screen hidden relative">
            <div class="lobby-wrapper w-full max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <div class="font-bold text-gray-400">SALA: <span id="displayRoomCode" class="text-white text-xl select-all"></span></div>
                    <button onclick="quitToMain()" class="bg-red-600 text-white px-3 py-1 rounded text-xs font-bold">SAIR</button>
                </div>

                <div class="lobby-content">
                    <div class="flex w-full gap-2 mb-2 flex-1 items-stretch justify-center h-48">
                        <div class="team-column border-blue-500/30">
                            <h3 class="text-blue-500 font-bold text-center text-[10px]">AZUL</h3>
                            <div id="list-blue"></div>
                        </div>
                        <div class="team-column border-white/30 bg-black/40">
                            <h3 class="text-white font-bold text-center text-[10px]">ESPEC</h3>
                            <div id="list-spec"></div>
                        </div>
                        <div class="team-column border-red-500/30">
                            <h3 class="text-red-500 font-bold text-center text-[10px]">VERMELHO</h3>
                            <div id="list-red"></div>
                        </div>
                    </div>
                    
                    <div id="admin-panel-btns" class="hidden text-center mt-4">
                        <button onclick="startGame()" class="bg-green-500 text-black px-8 py-3 rounded font-black text-lg w-full">INICIAR PARTIDA</button>
                    </div>
                    <p id="msg-wait" class="text-white/30 mt-4 text-center text-xs animate-pulse">AGUARDANDO O HOST...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURA√á√ÉO DE REDE LEVE ---
const peerConfig = {
    host: '0.peerjs.com', port: 443, secure: true,
    config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }], iceCandidatePoolSize: 2 }
};
// Conex√£o UDP-like (sem confiabilidade garantida = mais r√°pido)
const connectionOptions = { reliable: false, ordered: false };

let peer = null;
let conn = null; 
let connections = []; 
let isHost = false;
let myPeerId = null;

let myData = { nick: '', id: '', isAdmin: false, team: 'spec', isCaptain: false, r: 24 }; // RAIO PLAYER = 24

let lastNetworkUpdate = 0;
// ATEN√á√ÉO: Reduzi para 20 TPS (Ticks Per Second) para aliviar a banda
// O cliente interpola o resto. Menos pacotes = Menos lag de internet ruim
const networkUpdateRate = 1000 / 20; 

function generateRoomCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true }); // Otimiza√ß√£o Canvas
const FIELD_W = 2200, FIELD_H = 1200;
const GOAL_H_HALF = 160; 
const GOAL_DEPTH = 80;

const keys = { w: false, a: false, s: false, d: false };

// --- VARIAVEIS GLOBAIS ---
let isEditing = false, dragElement = null, selectedElement = null;
let gameZoom = 0.65; // Zoom um pouco mais afastado
let particles = [];
let timeLeft = 300; 
let activePlayerIdMenu = null; 
let isPaused = false; 

let roomPlayers = []; 
let bannedPlayers = []; 

// AUDIO CONTEXT (Simples)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    
    if(type === 'kick') {
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'goal') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
        osc.start(); osc.stop(audioCtx.currentTime + 1.0);
    }
}

// --- FUN√á√ïES DE MENU E NAVEGA√á√ÉO ---

function goToRoomMenu() {
    const nick = document.getElementById('playerNick').value.trim();
    if(!nick) { alert("NICK OBRIGAT√ìRIO"); return; }
    myData.nick = nick;
    if(!myData.id) myData.id = Math.random().toString(36).substr(2, 9);
    
    document.getElementById('screen-main').classList.add('hidden');
    document.getElementById('screen-room-select').classList.remove('hidden');
}

function backToMain() {
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-main').classList.remove('hidden');
    if(peer) { peer.destroy(); peer = null; }
}

function createRoom() {
    const code = generateRoomCode();
    const peerId = "SOC-V4-" + code; 
    document.getElementById('network-status').innerText = "Criando...";
    
    peer = new Peer(peerId, peerConfig);
    
    peer.on('open', (id) => {
        isHost = true; myPeerId = id;
        enterRoomLobby(code, true);
        document.getElementById('network-status').innerText = "HOST: " + code;
    });
    
    peer.on('connection', (c) => {
        connections.push(c);
        c.on('data', (data) => handleData(data, c));
        c.on('close', () => {
            connections = connections.filter(conn => conn !== c);
            if(c.peerPlayerId) {
                roomPlayers = roomPlayers.filter(p => p.id !== c.peerPlayerId);
                broadcastRoomState();
            }
        });
        c.send({ type: 'LOBBY_UPDATE', players: roomPlayers, isPaused: isPaused, score: score, timeLeft: timeLeft });
    });
    
    peer.on('error', (err) => { alert("Erro ao criar sala. Tente novamente."); backToMain(); });
}

function joinRoom() {
    const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
    if(code.length < 4) return;
    
    const hostId = "SOC-V4-" + code;
    document.getElementById('network-status').innerText = "Conectando...";
    peer = new Peer(peerConfig); 
    
    peer.on('open', (id) => {
        myPeerId = id;
        conn = peer.connect(hostId, connectionOptions);
        
        conn.on('open', () => {
            isHost = false;
            conn.send({ type: 'JOIN', player: myData });
            enterRoomLobby(code, false);
            document.getElementById('network-status').innerText = "Conectado: " + code;
        });
        
        conn.on('data', (data) => handleClientData(data));
        conn.on('close', () => { alert("Sala fechada pelo Host."); quitToMain(); });
        conn.on('error', () => { alert("Erro de conex√£o."); });
    });
}

function handleData(data, connection) {
    if(data.type === 'JOIN') {
        const newP = data.player;
        if(!roomPlayers.find(p => p.id === newP.id)) {
            newP.x = -5000; newP.y = -5000;
            newP.vx = 0; newP.vy = 0;
            newP.r = 24; 
            newP.input = {vx:0, vy:0, kick:0};
            roomPlayers.push(newP);
            connection.peerPlayerId = newP.id; 
        }
        broadcastRoomState();
    }
    if(data.type === 'INPUT') {
        const p = roomPlayers.find(pl => pl.id === data.id);
        if(p) {
            p.input = data.input; 
            // O host aceita o input do cliente.
            // Para evitar trapa√ßa, poder√≠amos validar, mas para evitar lag, aceitamos.
        }
    }
    if(data.type === 'CHAT') {
        appendMessageToAll(data.nick, data.msg);
        broadcast({ type: 'CHAT', nick: data.nick, msg: data.msg });
    }
}

function handleClientData(data) {
    if(data.type === 'LOBBY_UPDATE') {
        const isGameRunning = document.getElementById('lobby').style.display === 'none';
        
        if(!isGameRunning) roomPlayers = data.players;
        else {
            // Atualiza apenas metadados (quem √© time, quem √© capit√£o)
            data.players.forEach(srvP => {
                let localP = roomPlayers.find(p => p.id === srvP.id);
                if(localP) { localP.team = srvP.team; localP.isCaptain = srvP.isCaptain; localP.nick = srvP.nick; }
                else roomPlayers.push(srvP);
            });
            roomPlayers = roomPlayers.filter(p => data.players.find(srvP => srvP.id === p.id));
        }

        score = data.score || score;
        timeLeft = data.timeLeft || timeLeft;
        isPaused = data.isPaused;
        
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me) {
            myData.team = me.team;
            myData.isCaptain = me.isCaptain;
            player.time = (myData.team === 'spec') ? null : myData.team;
            if(data.gameRunning) updateControlsVisibility();
        }
        updateLobbyUI();
        
        if(data.gameRunning && !isGameRunning) startGameClient();
        else if(!data.gameRunning && isGameRunning) cancelMatchClient();
    }
    
    // --- NETCODE OTIMIZADO (V4) ---
    if(data.type === 'GT') { 
        // Bola: Interpola√ß√£o Linear
        ball.tx = data.b.x;
        ball.ty = data.b.y;
        
        // Se a bola teleportou muito longe (gol ou reset), move instant√¢neo
        if(Math.abs(ball.x - ball.tx) > 800) { ball.x = ball.tx; ball.y = ball.ty; }

        data.p.forEach(serverP => {
            let localP = roomPlayers.find(p => p.id === serverP.i); 
            if(localP) {
                // Se N√ÉO SOU EU, atualizo o alvo para interpola√ß√£o
                if(localP.id !== myData.id) {
                    localP.tx = serverP.x;
                    localP.ty = serverP.y;
                    // Corre√ß√£o instant√¢nea se desync for enorme
                    if(Math.abs(localP.x - localP.tx) > 600) { localP.x = localP.tx; localP.y = localP.ty; }
                } 
                // Se SOU EU, ignoro o servidor para movimento suave (Client-Side Prediction),
                // a menos que o servidor diga que estou muito longe (anti-cheat leve).
                else {
                    let dx = localP.x - serverP.x;
                    let dy = localP.y - serverP.y;
                    if(Math.sqrt(dx*dx + dy*dy) > 150) { // Toler√¢ncia alta pra n√£o dar "snap back" chato
                        localP.x = localP.x * 0.9 + serverP.x * 0.1;
                        localP.y = localP.y * 0.9 + serverP.y * 0.1;
                    }
                }
            }
        });

        score = data.s; 
        timeLeft = data.t; 
        updateGameInfoDOM();
    }

    if(data.type === 'GOAL_EVENT') { triggerGoal(data.scorer); }
    if(data.type === 'CHAT') { appendMessageToAll(data.nick, data.msg); }
}

function broadcast(msg) {
    connections.forEach(c => { if(c.open) c.send(msg); });
}

function broadcastRoomState() {
    const isRunning = document.getElementById('lobby').style.display === 'none';
    broadcast({ 
        type: 'LOBBY_UPDATE', 
        players: roomPlayers, 
        gameRunning: isRunning,
        isPaused: isPaused,
        score: score,
        timeLeft: timeLeft
    });
    updateLobbyUI(); 
}

function enterRoomLobby(code, isAdmin) {
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-room-lobby').classList.remove('hidden');
    document.getElementById('displayRoomCode').innerText = code;
    myData.isAdmin = isAdmin; myData.isCaptain = isAdmin; myData.team = 'spec'; 
    if(isHost) {
        roomPlayers = [{ ...myData, x: -5000, y: -5000, input: {vx:0, vy:0}, lastAction: Date.now() }];
    }
    updateLobbyUI();
}

function updateLobbyUI() {
    const isGameRunning = document.getElementById('lobby').style.display === 'none';
    const listBlue = document.getElementById('list-blue');
    const listRed = document.getElementById('list-red');
    const listSpec = document.getElementById('list-spec');
    
    if(listBlue) listBlue.innerHTML = ''; 
    if(listRed) listRed.innerHTML = ''; 
    if(listSpec) listSpec.innerHTML = '';

    const btnPanel = document.getElementById('admin-panel-btns');
    const msgWait = document.getElementById('msg-wait');
    if(!isGameRunning) {
        if(btnPanel) btnPanel.style.display = isHost ? 'block' : 'none';
        if(msgWait) msgWait.style.display = isHost ? 'none' : 'block';
    }

    roomPlayers.forEach(p => {
        const card = document.createElement('div');
        card.className = 'player-card';
        let optionsHTML = '';
        if(isHost && !isGameRunning && activePlayerIdMenu === p.id) {
            optionsHTML = `
                <div class="admin-options">
                    <div class="admin-row">
                        <div onclick="movePlayer('${p.id}', 'azul')" class="admin-btn bg-blue-600">AZUL</div>
                        <div onclick="movePlayer('${p.id}', 'vermelho')" class="admin-btn bg-red-600">VERM</div>
                        <div onclick="movePlayer('${p.id}', 'spec')" class="admin-btn bg-gray-500">SPEC</div>
                    </div>
                </div>`;
        }
        card.innerHTML = `
            <div onclick="togglePlayerMenu('${p.id}')" class="cursor-pointer flex justify-between">
                <span class="${p.id === myData.id ? 'text-green-400' : 'text-white'} truncate font-bold">${p.nick}</span>
            </div>
            ${optionsHTML}
        `;
        if(p.team === 'azul') listBlue?.appendChild(card);
        else if(p.team === 'vermelho') listRed?.appendChild(card);
        else listSpec?.appendChild(card);
    });
}

window.togglePlayerMenu = function(id) {
    if(!isHost) return; 
    activePlayerIdMenu = (activePlayerIdMenu === id) ? null : id;
    updateLobbyUI();
}

window.movePlayer = function(id, targetTeam) {
    if(!isHost) return;
    const p = roomPlayers.find(pl => pl.id === id);
    if(p) {
        p.team = targetTeam;
        activePlayerIdMenu = null; 
        broadcastRoomState();
    }
}

function startGame() {
    if(!isHost) return;
    isPaused = false;
    resetPositions();
    startGameClient();
    broadcastRoomState();
}

function startGameClient() {
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('scoreboard').style.display = 'flex';
    document.getElementById('hud-controls').style.display = 'block';
    updateControlsVisibility();
    resize();
}

function cancelMatchClient() {
    document.getElementById('scoreboard').style.display = 'none';
    document.getElementById('hud-controls').style.display = 'none';
    document.getElementById('ingame-modal').style.display = 'none';
    document.getElementById('lobby').style.display = 'block';
}

function updateControlsVisibility() {
    const isSpec = !player.time || player.time === 'spec';
    document.getElementById('joy-base').style.display = isSpec ? 'none' : 'block';
    document.getElementById('kickBtn').style.display = isSpec ? 'none' : 'flex';
    document.getElementById('passBtn').style.display = isSpec ? 'none' : 'flex';
}

function updateGameInfoDOM() {
    let mins = Math.floor(timeLeft / 60);
    let secs = timeLeft % 60;
    document.getElementById('timer').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    document.getElementById('scoreA').innerText = score.azul;
    document.getElementById('scoreV').innerText = score.verm;
}

function toggleIngameManager() {
    const modal = document.getElementById('ingame-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    const controls = document.getElementById('admin-game-controls');
    if(controls) controls.style.display = isHost ? 'flex' : 'none';
}

function resetMatch() {
    if(!isHost) return;
    score = {azul:0, verm:0}; timeLeft = 300;
    resetPositions();
    broadcastRoomState();
    toggleIngameManager();
}

function togglePause() {
    if(!isHost) return;
    isPaused = !isPaused;
    broadcastRoomState();
}

function cancelMatch() {
    if(!isHost) return;
    isPaused = false;
    cancelMatchClient();
    broadcastRoomState();
}

function quitToMain() {
    if(peer) { peer.destroy(); peer = null; }
    conn = null; connections = []; isHost = false;
    document.getElementById('lobby').style.display = 'block';
    document.getElementById('screen-main').classList.remove('hidden');
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-room-lobby').classList.add('hidden');
    document.getElementById('scoreboard').style.display = 'none';
    document.getElementById('hud-controls').style.display = 'none';
    document.getElementById('ingame-modal').style.display = 'none';
}

function toggleChat() {
    const chat = document.getElementById('chat-container');
    chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
}

function appendMessageToAll(nick, msg) {
    const line = `<div><strong>${nick}:</strong> ${msg}</div>`;
    const ingameDiv = document.getElementById('chat-msgs');
    if(ingameDiv) { ingameDiv.insertAdjacentHTML('beforeend', line); ingameDiv.scrollTop = ingameDiv.scrollHeight; }
}

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(msg !== "") {
        if(isHost) {
             appendMessageToAll(myData.nick, msg);
             broadcast({ type: 'CHAT', nick: myData.nick, msg: msg });
        } else if(conn) {
             conn.send({ type: 'CHAT', nick: myData.nick, msg: msg });
        }
        input.value = "";
    }
}

function startTimer() {
    setInterval(() => {
        if(isHost && !isPaused && document.getElementById('lobby').style.display === 'none' && timeLeft > 0) {
            timeLeft--;
            if(timeLeft === 0) { timeLeft = 300; resetPositions(); }
        }
    }, 1000);
}
startTimer();

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
    else if (document.exitFullscreen) document.exitFullscreen();
}

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight; 
    // DESATIVAR SUAVIZA√á√ÉO PARA GANHAR FPS
    ctx.imageRendering = 'pixelated'; 
}
window.addEventListener('resize', resize); resize();

// --- L√ìGICA DO JOGO ---

let player = { x: -5000, y: -5000, vx: 0, vy: 0, r: 24, time: '', nick: '', input: {vx:0, vy:0, kick:0} };
let ball = { x: FIELD_W/2, y: FIELD_H/2, vx: 0, vy: 0, r: 15, visible: true, tx: FIELD_W/2, ty: FIELD_H/2 }; 
let score = { azul: 0, verm: 0 }, joy = { active: false, angle: 0, force: 0, id: null };
let kickRequest = 0; 
let lastTouchNick = ""; 

// HUD Editor
function toggleHudEdit() {
    isEditing = !isEditing;
    document.getElementById('edit-panel').style.display = isEditing ? 'block' : 'none';
    if(isEditing) {
        document.getElementById('hud-controls').style.display = 'block';
        ['joy-base','kickBtn','passBtn'].forEach(id => document.getElementById(id).classList.add('editing'));
        document.getElementById('joy-base').style.display = 'block';
        document.getElementById('kickBtn').style.display = 'flex';
        document.getElementById('passBtn').style.display = 'flex';
    } else {
        ['joy-base','kickBtn','passBtn'].forEach(id => document.getElementById(id).classList.remove('editing'));
        if(document.getElementById('lobby').style.display !== 'none') document.getElementById('hud-controls').style.display = 'none';
        else updateControlsVisibility();
    }
}
function updateItemSize() {
    if(selectedElement) {
        const val = document.getElementById('size-slider').value + 'px';
        selectedElement.style.width = val; selectedElement.style.height = val;
    }
}
window.addEventListener('touchstart', (e) => {
    if(isEditing) {
        const t = e.changedTouches[0];
        ['joy-base', 'kickBtn', 'passBtn'].forEach(id => {
            const el = document.getElementById(id); const r = el.getBoundingClientRect();
            if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) {
                dragElement = el; selectedElement = el;
                document.getElementById('size-slider').value = parseInt(el.style.width) || 85;
            }
        });
    } else if(player.time) {
        const r = document.getElementById('joy-base').getBoundingClientRect();
        for(let t of e.changedTouches) {
            if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) { 
                joy.id = t.identifier; joy.active = true; 
            }
        }
    }
});
window.addEventListener('touchmove', (e) => {
    if(isEditing && dragElement) {
        const t = e.touches[0];
        dragElement.style.left = (t.clientX - dragElement.offsetWidth/2) + 'px';
        dragElement.style.top = (t.clientY - dragElement.offsetHeight/2) + 'px';
        dragElement.style.bottom = 'auto'; dragElement.style.right = 'auto';
    } else if(joy.active) {
        for(let touch of e.touches) if(touch.identifier === joy.id) {
            const r = document.getElementById('joy-base').getBoundingClientRect();
            const dx = touch.clientX - (r.left + r.width/2), dy = touch.clientY - (r.top + r.height/2);
            const dist = Math.min(r.width/2, Math.sqrt(dx*dx + dy*dy));
            joy.angle = Math.atan2(dy, dx); joy.force = dist / (r.width/2);
            document.getElementById('joy-stick').style.transform = `translate(${Math.cos(joy.angle)*dist}px, ${Math.sin(joy.angle)*dist}px)`;
        }
    }
});
window.addEventListener('touchend', (e) => {
    dragElement = null;
    for(let t of e.changedTouches) if(t.identifier === joy.id) { joy.active = false; joy.force = 0; document.getElementById('joy-stick').style.transform = `translate(0,0)`; }
});

document.getElementById('kickBtn').addEventListener('touchstart', (e) => { e.preventDefault(); kickRequest = 14; });
document.getElementById('passBtn').addEventListener('touchstart', (e) => { e.preventDefault(); kickRequest = 8; });

// CONTROLES PC
window.addEventListener('keydown', (e) => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = true; if(e.key === ' ') kickRequest = 14; });
window.addEventListener('keyup', (e) => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; });

function resetPositions() {
    ball.x = FIELD_W/2; ball.y = FIELD_H/2; ball.vx = 0; ball.vy = 0;
    ball.tx = FIELD_W/2; ball.ty = FIELD_H/2;
    
    const setPos = (p, x, y) => { p.x = x; p.y = y; p.vx = 0; p.vy = 0; p.tx = x; p.ty = y; };
    const azuis = roomPlayers.filter(p => p.team === 'azul');
    const vermelhos = roomPlayers.filter(p => p.team === 'vermelho');

    azuis.forEach((p, i) => setPos(p, 200 + (i*100), FIELD_H/2 + (i%2===0?-100:100)));
    vermelhos.forEach((p, i) => setPos(p, FIELD_W - (200 + (i*100)), FIELD_H/2 + (i%2===0?-100:100)));
    roomPlayers.forEach(p => { if(p.team === 'spec') setPos(p, -5000, -5000); });
}

function resolvePlayerCollisions() {
    for (let i = 0; i < roomPlayers.length; i++) {
        for (let j = i + 1; j < roomPlayers.length; j++) {
            let p1 = roomPlayers[i], p2 = roomPlayers[j];
            if (p1.x < -1000 || p2.x < -1000) continue;
            let dx = p2.x - p1.x, dy = p2.y - p1.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            let minDist = p1.r + p2.r;
            if (dist < minDist && dist > 0) {
                let overlap = minDist - dist;
                let moveX = (dx / dist) * (overlap / 2);
                let moveY = (dy / dist) * (overlap / 2);
                p1.x -= moveX; p1.y -= moveY; p2.x += moveX; p2.y += moveY;
            }
        }
    }
}

function triggerGoal(scorer) {
    playSound('goal');
    document.getElementById('goal-nick').innerText = scorer || "GOL";
    document.getElementById('goal-container').style.display = 'block';
    
    // Part√≠culas muito simples para n√£o lagar
    particles = [];
    for(let i=0; i<20; i++) particles.push({ x: canvas.width/2, y: canvas.height/2, vx: (Math.random()-0.5)*20, vy: (Math.random()-0.5)*20, life: 1 });

    setTimeout(() => {
        document.getElementById('goal-container').style.display = 'none';
        if(isHost) { resetPositions(); broadcastRoomState(); }
    }, 2500);
}

// === F√çSICA OTIMIZADA ===
// Limite de velocidade para n√£o atravessar
const MAX_SPEED = 25; 

function physicsStep() {
    roomPlayers.forEach(p => {
        if(!p.input || p.x < -1000) return;
        
        // Movimento
        p.vx += p.input.vx * 0.8; p.vy += p.input.vy * 0.8;
        p.vx *= 0.88; p.vy *= 0.88; // Atrito
        p.x += p.vx; p.y += p.vy;

        // Limites Campo
        if(p.y < p.r) p.y = p.r; if(p.y > FIELD_H - p.r) p.y = FIELD_H - p.r;
        if(p.x < p.r) p.x = p.r; if(p.x > FIELD_W - p.r) p.x = FIELD_W - p.r;

        // Chute (Raio aumentado para n√£o errar)
        if(p.input.kick > 0) {
             const dx = ball.x - p.x, dy = ball.y - p.y;
             const dist = Math.sqrt(dx*dx + dy*dy);
             if(dist < p.r + ball.r + 25) { 
                 ball.vx = (dx/dist)*p.input.kick * 1.5; 
                 ball.vy = (dy/dist)*p.input.kick * 1.5;
                 playSound('kick');
                 lastTouchNick = p.nick; 
             }
             p.input.kick = 0; 
        }

        // Colis√£o Corpo a Corpo com Bola
        let dx = ball.x - p.x, dy = ball.y - p.y, dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < p.r + ball.r) { 
            let ang = Math.atan2(dy, dx), overlap = (p.r + ball.r) - dist;
            ball.x += Math.cos(ang) * overlap; ball.y += Math.sin(ang) * overlap;
            ball.vx += Math.cos(ang) * 1.2; ball.vy += Math.sin(ang) * 1.2;
            lastTouchNick = p.nick; 
        }
    });

    resolvePlayerCollisions();

    // F√≠sica da Bola
    ball.x += ball.vx; ball.y += ball.vy; 
    ball.vx *= 0.98; ball.vy *= 0.98; // Atrito Bola

    // CLAMP VELOCITY (Anti-Tunneling)
    if(ball.vx > MAX_SPEED) ball.vx = MAX_SPEED; if(ball.vx < -MAX_SPEED) ball.vx = -MAX_SPEED;
    if(ball.vy > MAX_SPEED) ball.vy = MAX_SPEED; if(ball.vy < -MAX_SPEED) ball.vy = -MAX_SPEED;

    // Colis√£o Trave/Gol
    const topPost = FIELD_H/2 - GOAL_H_HALF;
    const botPost = FIELD_H/2 + GOAL_H_HALF;

    // Paredes verticais
    if(ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.8; }
    if(ball.y > FIELD_H - ball.r) { ball.y = FIELD_H - ball.r; ball.vy *= -0.8; }

    // Gols
    let inGoalY = (ball.y > topPost + ball.r) && (ball.y < botPost - ball.r);
    
    // Esquerda
    if(ball.x < ball.r) {
        if(inGoalY) {
            if(ball.x < -20) { 
                score.verm++; triggerGoal(lastTouchNick); ball.x = FIELD_W/2; ball.vx = 0; broadcast({type:'GOAL_EVENT', scorer: lastTouchNick});
            }
        } else {
            ball.x = ball.r; ball.vx *= -0.8;
        }
    }
    // Direita
    if(ball.x > FIELD_W - ball.r) {
        if(inGoalY) {
            if(ball.x > FIELD_W + 20) {
                score.azul++; triggerGoal(lastTouchNick); ball.x = FIELD_W/2; ball.vx = 0; broadcast({type:'GOAL_EVENT', scorer: lastTouchNick});
            }
        } else {
            ball.x = FIELD_W - ball.r; ball.vx *= -0.8;
        }
    }
    
    // Colis√£o com Postes (C√≠rculo Simples)
    const posts = [{x:0, y:topPost}, {x:0, y:botPost}, {x:FIELD_W, y:topPost}, {x:FIELD_W, y:botPost}];
    posts.forEach(p => {
        let dx = ball.x - p.x, dy = ball.y - p.y;
        if(Math.sqrt(dx*dx + dy*dy) < ball.r + 20) {
            let angle = Math.atan2(dy, dx);
            ball.vx = Math.cos(angle) * 5; ball.vy = Math.sin(angle) * 5;
            ball.x = p.x + Math.cos(angle)*(ball.r+21); ball.y = p.y + Math.sin(angle)*(ball.r+21);
        }
    });
}

function processInputLocal() {
    let moveX = 0, moveY = 0;
    if(keys.w) moveY = -1; if(keys.s) moveY = 1; if(keys.a) moveX = -1; if(keys.d) moveX = 1;
    let vx = 0, vy = 0;
    if(moveX || moveY) { let a = Math.atan2(moveY, moveX); vx = Math.cos(a); vy = Math.sin(a); }
    else if(joy.active) { vx = Math.cos(joy.angle) * joy.force; vy = Math.sin(joy.angle) * joy.force; }
    
    // Predi√ß√£o Client-Side
    if(!isHost && myData.id) {
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me) {
            me.vx += vx * 0.8; me.vy += vy * 0.8;
            me.vx *= 0.88; me.vy *= 0.88;
            me.x += me.vx; me.y += me.vy;
            // Limites Locais
            if(me.y < me.r) me.y = me.r; if(me.y > FIELD_H-me.r) me.y = FIELD_H-me.r;
        }
    }
    return { vx: vx, vy: vy, kick: kickRequest };
}

function loop() {
    if(document.getElementById('lobby').style.display !== 'none') { requestAnimationFrame(loop); return; }

    // Limpa tela (Background s√≥lido √© mais r√°pido que limpar frame a frame se cobrir tudo)
    ctx.fillStyle = "#1a4d2e"; ctx.fillRect(0, 0, canvas.width, canvas.height);

    if(!isPaused) {
        const myInput = processInputLocal();
        if(!isHost && conn && conn.open) conn.send({ type: 'INPUT', id: myData.id, input: myInput });
        if(isHost) {
            const me = roomPlayers.find(p => p.id === myData.id);
            if(me) me.input = myInput;
            
            // --- SUB-STEPPING (F√çSICA 2X MAIS R√ÅPIDA QUE O RENDER) ---
            // Isso previne que a bola atravesse coisas
            physicsStep();
            physicsStep();
            // --------------------------------------------------------

            const now = Date.now();
            if(now - lastNetworkUpdate > networkUpdateRate) {
                broadcast({ 
                    type: 'GT', 
                    p: roomPlayers.map(p => ({i:p.id, x:Math.round(p.x), y:Math.round(p.y)})),
                    b: {x:Math.round(ball.x), y:Math.round(ball.y)},
                    s: score, t: timeLeft
                });
                lastNetworkUpdate = now;
            }
        } 
        kickRequest = 0; 
    }

    // INTERPOLA√á√ÉO CLIENTE (Bola suave)
    if (!isHost && !isPaused) {
        // Aumentei o lerp para 0.5 (era 0.3) para ser mais responsivo
        ball.x += (ball.tx - ball.x) * 0.5;
        ball.y += (ball.ty - ball.y) * 0.5;
        
        roomPlayers.forEach(p => {
            if(p.id !== myData.id && p.tx !== undefined && p.x > -5000) {
                p.x += (p.tx - p.x) * 0.5;
                p.y += (p.ty - p.y) * 0.5;
            }
        });
    }

    // RENDERIZA√á√ÉO OTIMIZADA (SEM SOMBRAS)
    ctx.save();
    
    // Zoom e C√¢mera
    let cx = 0, cy = 0;
    if(isEditing) { cx = FIELD_W/2; cy = FIELD_H/2; }
    else {
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me && me.team !== 'spec' && me.x > -1000) { cx = me.x; cy = me.y; }
        else { cx = ball.x; cy = ball.y; }
    }
    
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(gameZoom, gameZoom);
    ctx.translate(-cx, -cy);

    // Desenha Campo (Linhas Simples)
    ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 4; 
    ctx.strokeRect(0, 0, FIELD_W, FIELD_H);
    ctx.beginPath(); ctx.moveTo(FIELD_W/2, 0); ctx.lineTo(FIELD_W/2, FIELD_H); ctx.stroke();
    ctx.beginPath(); ctx.arc(FIELD_W/2, FIELD_H/2, 130, 0, Math.PI*2); ctx.stroke();

    // Gols
    const ty = FIELD_H/2 - GOAL_H_HALF, by = FIELD_H/2 + GOAL_H_HALF;
    ctx.lineWidth = 6; ctx.strokeStyle = "#fff";
    ctx.beginPath(); ctx.moveTo(0, ty); ctx.lineTo(-GOAL_DEPTH, ty); ctx.lineTo(-GOAL_DEPTH, by); ctx.lineTo(0, by); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(FIELD_W, ty); ctx.lineTo(FIELD_W+GOAL_DEPTH, ty); ctx.lineTo(FIELD_W+GOAL_DEPTH, by); ctx.lineTo(FIELD_W, by); ctx.stroke();

    // Bola
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.stroke();
    
    // Jogadores
    roomPlayers.forEach(p => {
        if(p.x < -1000) return; 
        ctx.fillStyle = p.team === 'azul' ? '#2563eb' : '#dc2626';
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        
        // Indicador de dire√ß√£o simples
        if(p.id === myData.id) {
            ctx.strokeStyle = "#FFFF00"; ctx.lineWidth = 3; ctx.stroke();
        } else {
            ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
        }
        
        ctx.fillStyle = "white"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center";
        ctx.fillText(p.nick, p.x, p.y - 35);
    });
    
    // Part√≠culas (Gol)
    if(particles.length > 0) {
        ctx.fillStyle = "#FFFF00";
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            if(p.life > 0) ctx.fillRect(p.x, p.y, 8, 8);
            else particles.splice(i, 1);
        }
    }

    ctx.restore();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
