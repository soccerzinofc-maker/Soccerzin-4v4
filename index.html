<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOCCERZIN 4V4 - ULTRA OTIMIZADO 2.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* OTIMIZA√á√ÉO CSS: GPU e Toque */
        body { margin: 0; overflow: hidden; background: #052e16; touch-action: none; font-family: sans-serif; overscroll-behavior: none; user-select: none; -webkit-user-select: none; }
        
        canvas { 
            display: block; 
            background: #14532d;
            will-change: transform;
            transform: translateZ(0); 
        }
        
        #orientacao-aviso {
            display: none; position: fixed; inset: 0; background: #000; z-index: 999;
            color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        @media (orientation: portrait) { #orientacao-aviso { display: flex; } }

        .ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        #hud-controls { display: none; width: 100%; height: 100%; pointer-events: none; }

        .btn-game { 
            position: absolute; pointer-events: auto; width: 85px; height: 85px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 900; color: white; border: 3px solid rgba(255,255,255,0.8); z-index: 20;
            box-shadow: 0 6px 0 rgba(0,0,0,0.3), inset 0 2px 10px rgba(255,255,255,0.2);
            transition: transform 0.05s;
        }
        .btn-game:active { transform: translateY(4px); }
        
        #kickBtn { background: linear-gradient(145deg, #ea580c, #9a3412); display: none; }
        #passBtn { background: linear-gradient(145deg, #2563eb, #1e40af); display: none; }

        #joy-base { 
            position: absolute; width: 125px; height: 125px; 
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); 
            backdrop-filter: blur(5px); border-radius: 50%; pointer-events: auto; 
            display: none; 
        }
        #joy-stick { position: absolute; width: 45%; height: 45%; background: radial-gradient(circle, #fff, #cbd5e1); border-radius: 50%; top: 27.5%; left: 27.5%; pointer-events: none; }

        #top-left-controls { position: absolute; top: 20px; left: 20px; display: flex; gap: 8px; pointer-events: auto; flex-wrap: wrap; max-width: 300px; }
        
        .btn-hud-corner { 
            background: rgba(0,0,0,0.6); color: white; border-radius: 10px; padding: 8px 12px; 
            font-size: 14px; font-weight: bold; border: 1px solid white; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-hud-corner:hover { background: rgba(255,255,255,0.2); }

        #chat-container { position: absolute; top: 80px; left: 20px; width: 250px; height: 150px; background: rgba(0,0,0,0.5); border-radius: 10px; pointer-events: auto; display: none; flex-direction: column; padding: 10px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-msgs { flex: 1; overflow-y: auto; color: white; font-size: 12px; margin-bottom: 5px; text-shadow: 1px 1px 1px black; }
        #chat-input-row { display: flex; gap: 5px; }
        #chat-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 5px; flex: 1; font-size: 12px; }
        #chat-send { background: #22c55e; color: black; font-weight: bold; padding: 4px 10px; border-radius: 5px; font-size: 12px; }
        
        .lobby-wrapper { display: flex; flex-direction: column; height: 100vh; padding: 10px; box-sizing: border-box; }
        .lobby-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; min-height: 0; }
        
        .lobby-chat-box {
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px; width: 100%; max-width: 800px; height: 140px;
            display: flex; flex-direction: column; margin: 10px auto 0 auto; pointer-events: auto;
            flex-shrink: 0;
        }
        .lobby-msgs { flex: 1; overflow-y: auto; padding: 10px; color: white; font-size: 14px; text-align: left; }
        .lobby-input-area { display: flex; padding: 10px; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); }
        .lobby-input { flex: 1; background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px; border-radius: 5px; outline: none; }

        .editing { border: 4px dashed #facc15 !important; filter: brightness(1.2); display: flex !important; }
        .selected-edit { border: 6px solid #4ade80 !important; box-shadow: 0 0 20px #4ade80; }

        #edit-panel { 
            display: none; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
            pointer-events: auto; z-index: 100; width: 300px;
        }

        #goal-container { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 200; pointer-events: none; }
        #goal-title { color: #facc15; font-size: 100px; font-weight: 900; text-shadow: 0 10px 20px rgba(0,0,0,0.8); margin: 0; animation: goalAnim 0.5s infinite alternate; }
        @keyframes goalAnim { 0% { transform: scale(1) rotate(-2deg); } 100% { transform: scale(1.1) rotate(2deg); } }

        .menu-screen { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; }
        .team-column { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; width: 30%; height: 100%; overflow-y: auto; min-height: 200px; }
        
        .player-card { 
            background: rgba(0,0,0,0.6); margin-bottom: 5px; padding: 8px; border-radius: 5px; 
            display: flex; flex-direction: column; font-size: 12px; border: 1px solid rgba(255,255,255,0.1);
        }
        .player-header { display: flex; justify-content: space-between; align-items: center; width: 100%; cursor: pointer; }
        .admin-options { 
            display: flex; flex-direction: column; gap: 4px; margin-top: 8px; padding-top: 8px; 
            border-top: 1px solid rgba(255,255,255,0.2); 
        }
        .admin-row { display: flex; gap: 4px; width: 100%; }
        .admin-btn { flex: 1; padding: 6px; font-size: 10px; font-weight: bold; border-radius: 4px; cursor: pointer; text-align: center; color: white; display: flex; align-items: center; justify-content: center;}
        
        #ingame-top-right { position: absolute; top: 20px; right: 20px; display: none; gap: 10px; pointer-events: auto; }
        .btn-top { background: rgba(0,0,0,0.6); color: white; border: 1px solid white; padding: 8px 12px; border-radius: 10px; font-weight: bold; font-size: 12px; cursor: pointer; }
        .btn-top:hover { background: rgba(255,255,255,0.2); }

        #ingame-modal { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; pointer-events: auto; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }

        #error-msg { color: #ef4444; font-weight: bold; margin-top: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; display: none; }
        #network-status { position: absolute; bottom: 10px; left: 10px; color: yellow; font-size: 10px; z-index: 999; text-shadow: 1px 1px 2px black; }

        #credits-modal { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 500; pointer-events: auto; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .credits-box { background: #111; border: 2px solid #22c55e; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(34, 197, 94, 0.2); }
    </style>
</head>
<body>

<audio id="menu-music" loop>
    <source src="https://cdn.pixabay.com/audio/2022/11/22/audio_febc508520.mp3" type="audio/mp3">
</audio>

<div id="orientacao-aviso">üì±<h2 class="text-xl font-bold mt-4 italic">VIRE O CELULAR</h2></div>
<div id="network-status">Desconectado</div>

<canvas id="game"></canvas>

<div id="goal-container">
    <h1 id="goal-title">GOL!</h1>
    <p id="goal-nick" class="text-white text-3xl font-black italic shadow-lg uppercase tracking-wider drop-shadow-md"></p>
</div>

<div id="credits-modal">
    <div class="credits-box">
        <h2 class="text-4xl font-black italic text-green-500 mb-6">CR√âDITOS</h2>
        <p class="text-white text-xl font-bold mb-2">DOLLYKKJ</p>
        <p class="text-gray-400 text-sm mb-8">DESENVOLVEDOR</p>
        <button onclick="toggleCredits()" class="bg-white text-black px-8 py-2 rounded-full font-bold hover:bg-gray-200">FECHAR</button>
    </div>
    <div class="absolute bottom-5 right-5 text-gray-600 text-[10px] font-mono">
        TODOS OS CR√âDITOS RESERVADOS
    </div>
</div>

<div id="edit-panel" class="text-white">
    <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-green-400 italic text-sm">HUD EDITOR</h3>
    </div>
    <p class="text-[10px] text-gray-400 mb-2">Toque e arraste os bot√µes. Use as barras para ajustar.</p>
    <input type="range" id="size-slider" min="40" max="180" oninput="updateItemSize()" class="w-full accent-green-500">
    <input type="range" id="zoom-slider" min="0.5" max="1.5" step="0.05" oninput="updateZoom()" class="w-full mt-2 accent-green-500">
    <button onclick="toggleHudEdit()" class="mt-4 bg-green-500 text-black px-6 py-2 rounded-xl font-black w-full text-xs">SALVAR & SAIR</button>
</div>

<div id="ingame-modal" class="text-white">
    <h2 class="text-3xl font-black italic mb-6 text-green-500">GERENCIAR SALA</h2>
    
    <div class="flex w-full px-10 gap-4 mb-6 justify-center" style="max-width: 900px; height: 300px;">
        <div class="team-column border-blue-500/30">
            <h3 class="text-blue-500 font-black text-center mb-2">TIME AZUL</h3>
            <div id="ingame-list-blue" class="flex flex-col gap-2"></div>
        </div>
        <div class="team-column border-white/30 bg-black/40">
            <h3 class="text-white font-black text-center mb-2">ESPECTADORES</h3>
            <div id="ingame-list-spec" class="flex flex-col gap-2"></div>
        </div>
        <div class="team-column border-red-500/30">
            <h3 class="text-red-500 font-black text-center mb-2">TIME VERMELHO</h3>
            <div id="ingame-list-red" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <div id="admin-game-controls" class="flex flex-wrap justify-center gap-4 mb-6 w-full max-w-2xl px-4" style="display: none;">
        <button onclick="resetMatch()" class="bg-yellow-500 text-black px-6 py-3 rounded-xl font-bold hover:bg-yellow-400 shadow-lg grow">
            üîÑ RESETAR
        </button>
        <button onclick="togglePause()" id="btn-pause" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-500 shadow-lg grow">
            ‚è∏ PAUSAR
        </button>
        <button onclick="cancelMatch()" class="bg-red-700 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg grow border border-red-500">
            ‚ùå CANCELAR
        </button>
    </div>

    <div class="flex gap-2 mb-4">
        <button onclick="toggleGraphics()" id="btn-graphics-ingame" class="bg-purple-600 text-white px-6 py-2 rounded-xl font-bold">GR√ÅFICOS: ALTO</button>
        <button onclick="toggleIngameManager()" class="bg-white/20 text-white px-8 py-3 rounded-xl font-bold border border-white/20 hover:bg-white/30">FECHAR</button>
    </div>
</div>

<div class="ui-layer">
    <div id="scoreboard" class="hidden absolute top-5 left-1/2 -translate-x-1/2 bg-black/80 px-6 py-1 rounded-full border-2 border-white flex gap-6 text-2xl font-black text-white italic">
        <div id="timer" class="text-yellow-400 border-r border-white/20 pr-4">05:00</div>
        <span class="text-blue-500" id="scoreA">0</span><span class="text-red-500" id="scoreV">0</span>
    </div>

    <div id="hud-controls">
        <div id="top-left-controls">
            <div class="btn-hud-corner" onclick="toggleChat()">üí¨ CHAT</div>
            <div class="btn-hud-corner" onclick="toggleFullScreen()">‚õ∂ TELA</div>
            <div class="btn-hud-corner" onclick="toggleIngameManager()">üë• SALAS</div>
        </div>
        
        <div id="ingame-top-right">
            <button class="btn-top bg-red-500/50 hover:bg-red-500/80" onclick="quitToMain()">üîô SAIR</button>
        </div>

        <div id="chat-container">
            <div id="chat-msgs"></div>
            <div id="chat-input-row">
                <input type="text" id="chat-input" placeholder="Mensagem...">
                <button id="chat-send" onclick="sendChatMessage()">ENVIAR</button>
            </div>
        </div>

        <div id="joy-base" style="bottom: 40px; left: 40px;"><div id="joy-stick"></div></div>
        <div id="kickBtn" class="btn-game" style="bottom: 40px; right: 130px;">CHUTE</div>
        <div id="passBtn" class="btn-game" style="bottom: 40px; right: 30px;">PASSE</div>
    </div>

    <div id="lobby" class="absolute inset-0 bg-black/95 text-white pointer-events-auto">
        
        <div id="screen-main" class="menu-screen">
            <h1 class="text-7xl font-black italic mb-2">SOCCERZIN <span class="text-green-500">4V4</span></h1>
            <p class="text-xs text-green-400 font-bold mb-4 tracking-widest">‚ö° NETCODE V2 - ZERO LAG</p>
            <input type="text" id="playerNick" class="bg-white/5 border border-white/10 text-white px-4 py-4 rounded-2xl mb-6 w-72 text-center font-bold text-xl" placeholder="SEU NICKNAME" maxlength="12">
            
            <button onclick="goToRoomMenu()" class="bg-green-600 text-black px-10 py-5 rounded-2xl font-black text-2xl shadow-lg hover:scale-105 transition mb-6 w-72">JOGAR SALAS</button>
            
            <div class="flex gap-4 items-center flex-wrap justify-center w-full max-w-2xl px-4">
                <a href="https://discord.gg/MHewBNDX5S" target="_blank" class="text-[#5865F2] border border-[#5865F2]/50 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-[#5865F2]/10 transition no-underline">
                    üí¨ DISCORD
                </a>
                
                <button onclick="toggleCredits()" class="text-gray-300 border border-gray-300/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-gray-300/10 transition">
                    üìú CR√âDITOS
                </button>
                
                <button onclick="toggleHudEdit()" class="text-yellow-500 border border-yellow-500/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-yellow-500/10 transition">
                    ‚öôÔ∏è HUD
                </button>

                <button onclick="toggleGraphics()" id="btn-graphics" class="text-purple-400 border border-purple-500/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-purple-500/10 transition">
                    üéÆ GR√ÅFICOS: ALTO
                </button>
                
                <button onclick="toggleMusic()" id="btn-music" class="text-pink-400 border border-pink-500/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-pink-500/10 transition">
                    üéµ M√öSICA: OFF
                </button>
                
                <button onclick="toggleFullScreen()" class="text-white border border-white/30 px-6 py-2 rounded-full text-[10px] font-bold uppercase hover:bg-white/10 transition">
                    ‚õ∂ TELA CHEIA
                </button>
            </div>
        </div>

        <div id="screen-room-select" class="menu-screen hidden">
            <h2 class="text-4xl font-black italic mb-8">SALAS</h2>
            <div class="flex gap-6">
                <button onclick="createRoom()" class="bg-blue-600 w-48 h-48 rounded-2xl font-black text-2xl shadow-lg hover:scale-105 transition flex flex-col items-center justify-center gap-2">
                    <span>CRIAR SALA</span>
                    <span class="text-xs font-normal opacity-70">GERAR C√ìDIGO</span>
                </button>
                <div class="bg-white/5 w-48 h-48 rounded-2xl border border-white/10 flex flex-col items-center justify-center p-4">
                    <span class="font-bold mb-2">ENTRAR</span>
                    <input type="text" id="roomCodeInput" class="w-full bg-black/50 border border-white/20 rounded p-2 text-center mb-2 uppercase" placeholder="C√ìDIGO" maxlength="6">
                    <button onclick="joinRoom()" class="bg-green-600 w-full py-2 rounded font-bold text-black hover:bg-green-500">CONECTAR</button>
                    <p id="error-msg"></p>
                </div>
            </div>
            <button onclick="backToMain()" class="mt-8 text-white/50 hover:text-white">VOLTAR</button>
        </div>

        <div id="screen-room-lobby" class="menu-screen hidden relative">
            <div class="lobby-wrapper">
                <div class="absolute top-4 left-4 font-bold text-gray-400 z-50">SALA: <span id="displayRoomCode" class="text-white text-xl select-all"></span></div>
                <div class="absolute top-4 right-4 flex gap-2 z-50">
                    <button onclick="toggleFullScreen()" class="bg-white/10 text-white border border-white/20 px-4 py-2 rounded font-bold text-xs hover:bg-white/20">‚õ∂ TELA</button>
                    <button onclick="quitToMain()" class="bg-red-600 text-white px-4 py-2 rounded font-bold text-xs hover:bg-red-500">SAIR DA SALA</button>
                </div>

                <div class="lobby-content">
                    <h2 class="text-3xl font-black italic mb-2 text-green-500 text-center mt-10">GERENCIAMENTO</h2>
                    <p class="text-xs text-gray-500 mb-2 text-center">TOQUE NO NOME PARA OP√á√ïES (S√ì O CAPIT√ÉO)</p>

                    <div class="flex w-full px-10 gap-4 mb-2 flex-1 items-stretch justify-center">
                        <div class="team-column border-blue-500/30">
                            <h3 class="text-blue-500 font-black text-center mb-2 text-xs">AZUL (0/4)</h3>
                            <div id="list-blue" class="flex flex-col gap-2"></div>
                        </div>

                        <div class="team-column border-white/30 bg-black/40">
                            <h3 class="text-white font-black text-center mb-2 text-xs">ESPECTADORES</h3>
                            <div id="list-spec" class="flex flex-col gap-2"></div>
                        </div>

                        <div class="team-column border-red-500/30">
                            <h3 class="text-red-500 font-black text-center mb-2 text-xs">VERMELHO (0/4)</h3>
                            <div id="list-red" class="flex flex-col gap-2"></div>
                        </div>
                    </div>
                    
                    <div id="admin-panel-btns" class="hidden text-center mb-2">
                        <button onclick="startGame()" class="bg-green-500 text-black px-12 py-3 rounded-xl font-black text-xl shadow-lg hover:bg-green-400 transition">INICIAR PARTIDA</button>
                    </div>
                    <p id="msg-wait" class="text-white/50 mt-2 animate-pulse text-center">AGUARDANDO O CAPIT√ÉO INICIAR...</p>
                </div>

                <div class="lobby-chat-box">
                    <div id="lobby-chat-msgs" class="lobby-msgs">
                        <div class="text-white/30 italic text-xs">Chat da Sala - Combine os times!</div>
                    </div>
                    <div class="lobby-input-area">
                        <input type="text" id="lobby-chat-input" class="lobby-input" placeholder="Digite aqui..." maxlength="50">
                        <button onclick="sendLobbyChat()" class="bg-green-600 text-white px-6 rounded font-bold">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURA√á√ÉO DE REDE OTIMIZADA PARA DIST√ÇNCIA (V2) ---
// Usando servidores Google STUN para melhor conectividade P2P
const peerConfig = {
    host: '0.peerjs.com',
    port: 443,
    secure: true,
    pingInterval: 5000, // Mant√©m a conex√£o viva
    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' },
        ],
        iceCandidatePoolSize: 10
    }
};

// Configura√ß√£o UDP agressiva para evitar fila de pacotes (Head-of-line blocking)
const connectionOptions = {
    reliable: false, 
    ordered: false, // O SEGREDO DO "ZERO LAG": Se um pacote perder, ignora e pega o pr√≥ximo mais recente.
    serialization: 'json'
};

let peer = null;
let conn = null; 
let connections = []; 
let isHost = false;
let myPeerId = null;

let myData = { nick: '', id: '', isAdmin: false, team: 'spec', isCaptain: false, r: 24 };

let lastNetworkUpdate = 0;
const networkUpdateRate = 1000 / 30; // 30 TICKS/SEC (Est√°vel)

function generateRoomCode() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let result = "";
    for(let i=0; i<6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
    return result;
}

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true }); // Desynchronized ajuda na lat√™ncia de render
const FIELD_W = 2200, FIELD_H = 1200;
const GOAL_H_HALF = 160; 
const GOAL_DEPTH = 80;

const keys = { w: false, a: false, s: false, d: false };
let graphicsLow = false;

// OTIMIZA√á√ÉO: Detectar celular fraco inicialmente
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
if(isMobile) graphicsLow = true;

function toggleGraphics() {
    graphicsLow = !graphicsLow;
    const btn = document.getElementById('btn-graphics');
    const btnIngame = document.getElementById('btn-graphics-ingame');
    const label = graphicsLow ? "GR√ÅFICOS: BAIXO" : "GR√ÅFICOS: ALTO";
    btn.innerText = "üéÆ " + label;
    btnIngame.innerText = label;
    resize();
}

let isEditing = false, dragElement = null, selectedElement = null;
let gameZoom = 0.75; 
let particles = [];
let timeLeft = 300; 
let activePlayerIdMenu = null; 
let isPaused = false; 

let gameState = 'MENU'; 
let roomPlayers = []; 
let bannedPlayers = []; 

const bgm = document.getElementById('menu-music');
let musicOn = false;

function toggleMusic() {
    const btn = document.getElementById('btn-music');
    if(musicOn) {
        bgm.pause();
        musicOn = false;
        btn.innerText = "üéµ M√öSICA: OFF";
        btn.classList.add('opacity-50');
    } else {
        bgm.volume = 0.4; 
        bgm.play().then(() => {
            musicOn = true;
            btn.innerText = "üéµ M√öSICA: ON";
            btn.classList.remove('opacity-50');
        }).catch(e => {
            alert("Toque na tela para permitir o √°udio!");
        });
    }
}

function toggleCredits() {
    const el = document.getElementById('credits-modal');
    el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
}

function goToRoomMenu() {
    const nick = document.getElementById('playerNick').value.trim();
    if(!nick) { alert("DIGITE UM NICKNAME!"); return; }
    myData.nick = nick;
    if(!myData.id) myData.id = Math.random().toString(36).substr(2, 9);
    
    document.getElementById('screen-main').classList.add('hidden');
    document.getElementById('screen-room-select').classList.remove('hidden');
    document.getElementById('error-msg').style.display = 'none';
}

function backToMain() {
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-main').classList.remove('hidden');
    if(peer) { peer.destroy(); peer = null; }
}

function createRoom() {
    const code = generateRoomCode();
    const peerId = "SOC-PRO-" + code;
    document.getElementById('network-status').innerText = "Criando sala " + code + "...";
    
    peer = new Peer(peerId, peerConfig);
    
    peer.on('open', (id) => {
        isHost = true;
        myPeerId = id;
        enterRoomLobby(code, true);
        document.getElementById('network-status').innerText = "Hospedando: " + code;
    });
    
    peer.on('connection', (c) => {
        connections.push(c);
        c.on('data', (data) => {
            handleData(data, c);
        });
        c.on('close', () => {
            connections = connections.filter(conn => conn !== c);
            if(c.peerPlayerId) {
                roomPlayers = roomPlayers.filter(p => p.id !== c.peerPlayerId);
                broadcastRoomState();
            }
        });
        // Enviar estado inicial FULL (LOBBY_UPDATE cont√©m nicks e times)
        c.send({ type: 'LOBBY_UPDATE', players: roomPlayers, isPaused: isPaused, score: score, timeLeft: timeLeft });
    });
    
    peer.on('error', (err) => {
        console.log(err);
        alert("Erro ao criar sala. C√≥digo em uso ou erro de rede.");
        backToMain();
    });
}

function joinRoom() {
    const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
    const errorEl = document.getElementById('error-msg');
    
    if(code.length < 3) {
        errorEl.innerText = "C√ìDIGO INV√ÅLIDO!";
        errorEl.style.display = 'block';
        return;
    }
    
    const hostId = "SOC-PRO-" + code;
    peer = new Peer(peerConfig); 
    
    peer.on('open', (id) => {
        myPeerId = id;
        
        conn = peer.connect(hostId, connectionOptions);
        
        conn.on('open', () => {
            isHost = false;
            conn.send({ type: 'JOIN', player: myData });
            enterRoomLobby(code, false);
            document.getElementById('network-status').innerText = "Conectado a " + code;
        });
        
        conn.on('data', (data) => {
            handleClientData(data);
        });
        
        conn.on('close', () => {
            alert("O Host encerrou a sala!");
            quitToMain();
        });
        
        conn.on('error', (err) => {
            errorEl.innerText = "SALA N√ÉO ENCONTRADA!";
            errorEl.style.display = 'block';
        });
    });
    
    peer.on('error', (err) => {
        errorEl.innerText = "ERRO DE CONEX√ÉO!";
        errorEl.style.display = 'block';
    });
}

function handleData(data, connection) {
    if(data.type === 'JOIN') {
        const newP = data.player;
        if(bannedPlayers.includes(newP.id)) {
            connection.send({ type: 'KICKED', msg: "Voc√™ est√° banido desta sala." });
            setTimeout(() => connection.close(), 500);
            return;
        }
        if(!roomPlayers.find(p => p.id === newP.id)) {
            newP.x = -9999; newP.y = -9999;
            newP.r = 24;
            newP.lastAction = Date.now(); 
            roomPlayers.push(newP);
            connection.peerPlayerId = newP.id; 
        }
        broadcastRoomState();
    }
    if(data.type === 'INPUT') {
        const p = roomPlayers.find(pl => pl.id === data.id);
        if(p) {
            // Aceita o input mais recente, n√£o precisa de valida√ß√£o complexa pra esse tipo de jogo
            p.input = data.input; 
            p.lastAction = Date.now();
        }
    }
    if(data.type === 'CHAT') {
        appendMessageToAll(data.nick, data.msg);
        broadcast({ type: 'CHAT', nick: data.nick, msg: data.msg });
        const p = roomPlayers.find(pl => pl.nick === data.nick);
        if(p) p.lastAction = Date.now();
    }
}

function updateGameInfoDOM(t, s) {
    let mins = Math.floor(t / 60);
    let secs = t % 60;
    document.getElementById('timer').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    document.getElementById('scoreA').innerText = s.azul;
    document.getElementById('scoreV').innerText = s.verm;
}

function handleClientData(data) {
    // 1. Atualiza√ß√£o completa do LOBBY (acontece raramente, cont√©m strings pesadas)
    if(data.type === 'LOBBY_UPDATE') {
        const isGameRunning = document.getElementById('lobby').style.display === 'none';
        
        if(!isGameRunning) {
            roomPlayers = data.players; // No lobby, atualiza tudo
        } else {
            // Ingame, atualiza metadados (times, nicks) mas preserva posi√ß√µes locais se existirem
            data.players.forEach(srvP => {
                let localP = roomPlayers.find(p => p.id === srvP.id);
                if(localP) {
                    localP.team = srvP.team;
                    localP.isCaptain = srvP.isCaptain;
                    localP.nick = srvP.nick;
                } else {
                    roomPlayers.push(srvP);
                }
            });
            // Remove quem saiu
            roomPlayers = roomPlayers.filter(p => data.players.find(srvP => srvP.id === p.id));
        }

        score = data.score || score;
        timeLeft = data.timeLeft || timeLeft;
        isPaused = data.isPaused;
        
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me) {
            myData.team = me.team;
            myData.isCaptain = me.isCaptain;
            player.time = (myData.team === 'spec') ? null : myData.team;
            
            if(data.gameRunning) {
                updateControlsVisibility();
            }
        }
        updateLobbyUI();
        
        const isGameRunningLocally = document.getElementById('lobby').style.display === 'none';
        if(data.gameRunning && !isGameRunningLocally) startGameClient();
        else if(!data.gameRunning && isGameRunningLocally) cancelMatchClient();
    }
    
    // 2. TICK DO JOGO (Ultra Leve - S√≥ n√∫meros)
    if(data.type === 'GT') { // GT = Game Tick
        // Bola
        ball.tx = data.b.x;
        ball.ty = data.b.y;
        
        // Corre√ß√£o abrupta se dessincronizar muito
        if(Math.abs(ball.x - ball.tx) > 500) { ball.x = ball.tx; ball.y = ball.ty; }

        // Players (Payload comprimido: [id, x, y])
        data.p.forEach(serverP => {
            let localP = roomPlayers.find(p => p.id === serverP.i); // i = id
            if(localP) {
                localP.tx = serverP.x;
                localP.ty = serverP.y;
                // Corre√ß√£o de teleport
                if(Math.abs(localP.x - localP.tx) > 500) { 
                    localP.x = localP.tx; localP.y = localP.ty; 
                }
            }
        });

        score = data.s; // s = score
        timeLeft = data.t; // t = time
        updateGameInfoDOM(timeLeft, score);
    }

    if(data.type === 'GOAL_EVENT') {
        triggerGoal(data.scorer);
    }

    if(data.type === 'CHAT') {
        appendMessageToAll(data.nick, data.msg);
    }

    if(data.type === 'KICKED') {
        alert(data.msg);
        quitToMain();
    }
}

function broadcast(msg) {
    connections.forEach(c => {
        if(c.open) c.send(msg);
    });
}

function broadcastRoomState() {
    const isRunning = document.getElementById('lobby').style.display === 'none';
    broadcast({ 
        type: 'LOBBY_UPDATE', 
        players: roomPlayers, 
        gameRunning: isRunning,
        isPaused: isPaused,
        score: score,
        timeLeft: timeLeft
    });
    updateLobbyUI(); 
}

function enterRoomLobby(code, isAdmin) {
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-room-lobby').classList.remove('hidden');
    document.getElementById('displayRoomCode').innerText = code;
    
    myData.isAdmin = isAdmin;
    myData.isCaptain = isAdmin; 
    myData.team = 'spec'; 
    bannedPlayers = []; 
    
    if(isHost) {
        roomPlayers = [{ ...myData, x: -9999, y: -9999, input: {vx:0, vy:0}, lastAction: Date.now() }];
    }
    updateLobbyUI();
}

function updateLobbyUI() {
    const isGameRunning = document.getElementById('lobby').style.display === 'none';
    const prefix = isGameRunning ? 'ingame-list-' : 'list-';
    const listBlue = document.getElementById(prefix + 'blue');
    const listRed = document.getElementById(prefix + 'red');
    const listSpec = document.getElementById(prefix + 'spec');
    
    if(listBlue) listBlue.innerHTML = ''; 
    if(listRed) listRed.innerHTML = ''; 
    if(listSpec) listSpec.innerHTML = '';

    const me = roomPlayers.find(p => p.id === myData.id);
    const iAmCaptain = me && me.isCaptain;

    if(!isGameRunning) {
        const btnPanel = document.getElementById('admin-panel-btns');
        const msgWait = document.getElementById('msg-wait');
        if(btnPanel) btnPanel.style.display = isHost ? 'block' : 'none';
        if(msgWait) msgWait.style.display = isHost ? 'none' : 'block';
    }

    roomPlayers.forEach(p => {
        const card = document.createElement('div');
        card.className = 'player-card';
        
        const showOptions = (activePlayerIdMenu === p.id) && iAmCaptain && isHost;

        let optionsHTML = '';
        if(showOptions) {
            const teamRow = `
                <div class="admin-row">
                    <div onclick="movePlayer('${p.id}', 'azul')" class="admin-btn bg-blue-600 hover:bg-blue-500">TIME AZUL</div>
                    <div onclick="movePlayer('${p.id}', 'vermelho')" class="admin-btn bg-red-600 hover:bg-red-500">TIME VERM</div>
                </div>
            `;
            
            let actionRow = '';
            const btnSpec = `<div onclick="movePlayer('${p.id}', 'spec')" class="admin-btn bg-gray-500 hover:bg-gray-400">üëÄ SPEC</div>`;
            
            if(p.id !== myData.id) {
                actionRow = `
                    <div class="admin-row">
                        ${btnSpec}
                        <div onclick="kickPlayer('${p.id}')" class="admin-btn bg-orange-600 text-black hover:bg-orange-500">KITAR</div>
                        <div onclick="banPlayer('${p.id}')" class="admin-btn bg-black border border-red-500 text-red-500 hover:bg-red-900">BANIR</div>
                    </div>
                `;
            } else {
                actionRow = `
                    <div class="admin-row">
                        ${btnSpec}
                    </div>
                `;
            }

            optionsHTML = `<div class="admin-options">${teamRow} ${actionRow}</div>`;
        }

        card.innerHTML = `
            <div class="player-header" onclick="togglePlayerMenu('${p.id}')">
                <span class="${p.id === myData.id ? 'text-green-400' : 'text-white'} font-bold truncate">
                    ${p.isCaptain ? 'üëë' : ''} ${p.nick}
                </span>
                <span class="text-xs text-gray-400">${iAmCaptain && isHost ? '‚ñº' : ''}</span>
            </div>
            ${optionsHTML}
        `;

        if(p.team === 'azul') listBlue?.appendChild(card);
        else if(p.team === 'vermelho') listRed?.appendChild(card);
        else listSpec?.appendChild(card);
    });
}

window.togglePlayerMenu = function(id) {
    if(!isHost) return; 
    if(activePlayerIdMenu === id) activePlayerIdMenu = null;
    else activePlayerIdMenu = id;
    updateLobbyUI();
}

window.movePlayer = function(id, targetTeam) {
    if(!isHost) return;
    const p = roomPlayers.find(pl => pl.id === id);
    if(p) {
        p.team = targetTeam;
        p.x = -9999; p.y = -9999; 
        p.vx = 0; p.vy = 0;
        activePlayerIdMenu = null; 
        broadcastRoomState();
    }
}

window.kickPlayer = function(id, reason="Voc√™ foi expulso.") {
    if(!isHost) return;
    const connToKick = connections.find(c => c.peerPlayerId === id);
    if(connToKick) {
        connToKick.send({ type: 'KICKED', msg: reason });
        setTimeout(() => connToKick.close(), 100);
    }
    roomPlayers = roomPlayers.filter(p => p.id !== id);
    activePlayerIdMenu = null;
    broadcastRoomState();
}

window.banPlayer = function(id) {
    if(!isHost) return;
    if(!confirm("Banir jogador?")) return;
    bannedPlayers.push(id);
    window.kickPlayer(id, "Voc√™ foi banido.");
}

window.startGame = function() {
    if(!isHost) return;
    isPaused = false;
    resetPositions();
    
    const now = Date.now();
    roomPlayers.forEach(p => p.lastAction = now);

    startGameClient();
    broadcastRoomState();
}

function updateControlsVisibility() {
    const isSpec = !player.time || player.time === 'spec';
    
    const joy = document.getElementById('joy-base');
    const btnK = document.getElementById('kickBtn');
    const btnP = document.getElementById('passBtn');

    if(joy) joy.style.display = isSpec ? 'none' : 'block';
    if(btnK) btnK.style.display = isSpec ? 'none' : 'flex';
    if(btnP) btnP.style.display = isSpec ? 'none' : 'flex';
}

function startGameClient() {
    if(musicOn) bgm.pause();
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('scoreboard').style.display = 'flex';
    document.getElementById('ingame-top-right').style.display = 'flex';
    
    const me = roomPlayers.find(p => p.id === myData.id);
    if(me) {
        player.time = (me.team === 'spec') ? null : me.team;
        player.nick = me.nick;
    }

    document.getElementById('hud-controls').style.display = 'block';
    updateControlsVisibility(); 

    if(isHost) {
        updateGameInfoDOM(timeLeft, score);
    }
}

function cancelMatchClient() {
    isPaused = false;
    if(musicOn) bgm.play();
    document.getElementById('scoreboard').style.display = 'none';
    document.getElementById('hud-controls').style.display = 'none';
    document.getElementById('ingame-top-right').style.display = 'none';
    document.getElementById('ingame-modal').style.display = 'none';
    document.getElementById('lobby').style.display = 'block';
    document.getElementById('screen-room-lobby').classList.remove('hidden');
    player.time = null; 
    updateLobbyUI();
}

function toggleIngameManager() {
    const modal = document.getElementById('ingame-modal');
    if(modal.style.display === 'flex') {
        modal.style.display = 'none';
        activePlayerIdMenu = null;
    } else {
        modal.style.display = 'flex';
        updateLobbyUI(); 
        const controls = document.getElementById('admin-game-controls');
        if(controls) {
            controls.style.display = isHost ? 'flex' : 'none';
        }
    }
}

function togglePause() {
    if(!isHost) return;
    isPaused = !isPaused;
    broadcastRoomState();
    updatePauseBtn();
}

function updatePauseBtn() {
    const btn = document.getElementById('btn-pause');
    if(isPaused) {
        btn.innerHTML = "‚ñ∂ RESUMIR";
        btn.classList.replace('bg-blue-600', 'bg-green-600');
    } else {
        btn.innerHTML = "‚è∏ PAUSAR";
        btn.classList.replace('bg-green-600', 'bg-blue-600');
    }
    toggleIngameManager(); 
}

function resetMatch() {
    if(!isHost) return;
    if(!confirm("Resetar partida?")) return;
    score.azul = 0; score.verm = 0;
    timeLeft = 300;
    resetPositions();
    isPaused = false;
    broadcastRoomState();
    updatePauseBtn();
}

function cancelMatch() {
    if(!isHost) return;
    if(!confirm("Cancelar e voltar ao Lobby?")) return;
    isPaused = false;
    cancelMatchClient();
    broadcastRoomState();
}

function quitToMain() {
    if(!confirm("Sair da sala?")) return;
    if(peer) { peer.destroy(); peer = null; }
    conn = null; connections = [];
    isHost = false;
    player.time = null; player.nick = ''; player.x = -9999; player.y = -9999;
    isPaused = false;
    if(musicOn) bgm.play();
    document.getElementById('lobby').style.display = 'block';
    document.getElementById('screen-main').classList.remove('hidden');
    document.getElementById('screen-room-select').classList.add('hidden');
    document.getElementById('screen-room-lobby').classList.add('hidden');
    document.getElementById('scoreboard').style.display = 'none';
    document.getElementById('hud-controls').style.display = 'none';
    document.getElementById('ingame-modal').style.display = 'none';
    document.getElementById('ingame-top-right').style.display = 'none';
    document.getElementById('credits-modal').style.display = 'none';
    document.getElementById('network-status').innerText = "Desconectado";
    roomPlayers = []; myData.team = 'spec'; myData.isCaptain = false;
    activePlayerIdMenu = null; isEditing = false;
    document.getElementById('edit-panel').style.display = 'none';
}

function toggleChat() {
    const chat = document.getElementById('chat-container');
    chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
}

function appendMessageToAll(nick, msg) {
    const line = `<div><strong>${nick}:</strong> ${msg}</div>`;
    const ingameDiv = document.getElementById('chat-msgs');
    if(ingameDiv) { ingameDiv.insertAdjacentHTML('beforeend', line); ingameDiv.scrollTop = ingameDiv.scrollHeight; }
    const lobbyDiv = document.getElementById('lobby-chat-msgs');
    if(lobbyDiv) { lobbyDiv.insertAdjacentHTML('beforeend', line); lobbyDiv.scrollTop = lobbyDiv.scrollHeight; }
}

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(msg !== "") {
        if(isHost) {
             appendMessageToAll(myData.nick, msg);
             broadcast({ type: 'CHAT', nick: myData.nick, msg: msg });
        } else if(conn) {
             conn.send({ type: 'CHAT', nick: myData.nick, msg: msg });
        }
        input.value = "";
    }
}

function sendLobbyChat() {
    const input = document.getElementById('lobby-chat-input');
    const msg = input.value.trim();
    if(msg !== "") {
        if(isHost) {
             appendMessageToAll(myData.nick, msg);
             broadcast({ type: 'CHAT', nick: myData.nick, msg: msg });
        } else if(conn) {
             conn.send({ type: 'CHAT', nick: myData.nick, msg: msg });
        }
        input.value = "";
    }
}

document.getElementById('lobby-chat-input').addEventListener('keydown', function(e) { if(e.key === 'Enter') sendLobbyChat(); });
document.getElementById('chat-input').addEventListener('keydown', function(e) { if(e.key === 'Enter') sendChatMessage(); });

function startTimer() {
    setInterval(() => {
        if(!isHost) return;
        if(!isPaused && document.getElementById('lobby').style.display === 'none' && timeLeft > 0) {
            timeLeft--;
            if(timeLeft === 0) { timeLeft = 300; resetPositions(); }
        }
    }, 1000);
}
startTimer();

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    if(type === 'kick') {
        osc.frequency.setValueAtTime(120, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    } else if (type === 'post') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    } else if (type === 'goal') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(400, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
    }
    osc.start(); osc.stop(audioCtx.currentTime + (type==='goal'?1.0:0.5));
}

function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
    else if (document.exitFullscreen) document.exitFullscreen();
}

function resize() { 
    let ratio = window.devicePixelRatio || 1;
    if (graphicsLow) ratio = 1;
    else if (ratio > 1.5) ratio = 1.5; 

    canvas.width = window.innerWidth * ratio; 
    canvas.height = window.innerHeight * ratio; 
    
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    
    if(graphicsLow) canvas.style.imageRendering = 'pixelated';
    else canvas.style.imageRendering = 'auto';
}
window.addEventListener('resize', resize); resize();

let player = { x: -9999, y: -9999, vx: 0, vy: 0, r: 24, time: '', nick: '', input: {vx:0, vy:0, kick:0} };
let ball = { x: FIELD_W/2, y: FIELD_H/2, vx: 0, vy: 0, r: 15, visible: true, tx: FIELD_W/2, ty: FIELD_H/2 }; 
let score = { azul: 0, verm: 0 }, joy = { active: false, angle: 0, force: 0, id: null };
let isGoalProcess = false;
let kickRequest = 0; 
let lastTouchNick = "ALGU√âM"; 

function toggleHudEdit() {
    isEditing = !isEditing;
    const hudControls = document.getElementById('hud-controls');
    const joyBase = document.getElementById('joy-base');
    const kickBtn = document.getElementById('kickBtn');
    const passBtn = document.getElementById('passBtn');
    
    if(isEditing) {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('edit-panel').style.display = 'block';
        hudControls.style.display = 'block';
        document.getElementById('chat-container').style.display = 'none';
        document.getElementById('top-left-controls').style.display = 'none';
        joyBase.classList.add('editing');
        kickBtn.classList.add('editing');
        passBtn.classList.add('editing');
    } else {
        document.getElementById('edit-panel').style.display = 'none';
        document.getElementById('top-left-controls').style.display = 'flex';
        joyBase.classList.remove('editing');
        kickBtn.classList.remove('editing');
        passBtn.classList.remove('editing');
        
        const inLobby = !document.getElementById('screen-room-lobby').classList.contains('hidden');
        const inMain = !document.getElementById('screen-main').classList.contains('hidden');
        
        if(inLobby || inMain) {
            document.getElementById('lobby').style.display = 'block';
            hudControls.style.display = 'none';
        } else {
            hudControls.style.display = 'block';
        }
    }
    if(!isEditing) selectedElement = null;
    ['joy-base', 'kickBtn', 'passBtn'].forEach(id => document.getElementById(id).classList.remove('selected-edit'));
}

function updateItemSize() {
    if(!selectedElement) return;
    const val = document.getElementById('size-slider').value + 'px';
    selectedElement.style.width = val; selectedElement.style.height = val;
}
function updateZoom() { gameZoom = parseFloat(document.getElementById('zoom-slider').value); }

window.addEventListener('touchstart', (e) => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const t = e.changedTouches[0];
    if(isEditing) {
        ['joy-base', 'kickBtn', 'passBtn'].forEach(id => {
            const el = document.getElementById(id); const r = el.getBoundingClientRect();
            if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) {
                dragElement = el; selectedElement = el;
                ['joy-base', 'kickBtn', 'passBtn'].forEach(i => document.getElementById(i).classList.remove('selected-edit'));
                el.classList.add('selected-edit');
                document.getElementById('size-slider').value = parseInt(el.style.width) || 85;
            }
        });
    } else if(player.time) {
        const r = document.getElementById('joy-base').getBoundingClientRect();
        if(t.clientX > r.left && t.clientX < r.right && t.clientY > r.top && t.clientY < r.bottom) { joy.id = t.identifier; joy.active = true; }
    }
});

window.addEventListener('touchmove', (e) => {
    if(isEditing && dragElement) {
        const t = e.touches[0];
        dragElement.style.left = (t.clientX - dragElement.offsetWidth/2) + 'px';
        dragElement.style.top = (t.clientY - dragElement.offsetHeight/2) + 'px';
        dragElement.style.bottom = 'auto'; dragElement.style.right = 'auto';
    } else if(joy.active) {
        for(let touch of e.touches) if(touch.identifier === joy.id) {
            const r = document.getElementById('joy-base').getBoundingClientRect();
            const dx = touch.clientX - (r.left + r.width/2), dy = touch.clientY - (r.top + r.height/2);
            const dist = Math.min(r.width/2, Math.sqrt(dx*dx + dy*dy));
            joy.angle = Math.atan2(dy, dx); joy.force = dist / (r.width/2);
            document.getElementById('joy-stick').style.transform = `translate(${Math.cos(joy.angle)*dist}px, ${Math.sin(joy.angle)*dist}px)`;
        }
    }
});

window.addEventListener('touchend', (e) => {
    dragElement = null;
    for(let t of e.changedTouches) if(t.identifier === joy.id) { joy.active = false; joy.force = 0; document.getElementById('joy-stick').style.transform = `translate(0,0)`; }
});

window.addEventListener('keydown', (e) => {
    if (document.activeElement.tagName === 'INPUT') return;
    const k = e.key.toLowerCase();
    if(keys.hasOwnProperty(k)) keys[k] = true;
    if(k === 'n') kickRequest = 13; 
    if(k === 'm') kickRequest = 8; 
});

window.addEventListener('keyup', (e) => {
    const k = e.key.toLowerCase();
    if(keys.hasOwnProperty(k)) keys[k] = false;
});

document.getElementById('kickBtn').addEventListener('touchstart', (e) => { e.preventDefault(); kickRequest = 13; });
document.getElementById('passBtn').addEventListener('touchstart', (e) => { e.preventDefault(); kickRequest = 8; });

function resetPositions() {
    ball.x = FIELD_W/2; ball.y = FIELD_H/2; ball.vx = 0; ball.vy = 0;
    ball.tx = FIELD_W/2; ball.ty = FIELD_H/2;
    lastTouchNick = "ALGU√âM"; 
    
    const setPos = (p, x, y) => { 
        p.x = x; p.y = y; p.vx = 0; p.vy = 0;
        p.tx = x; p.ty = y;
    };
    const azuis = roomPlayers.filter(p => p.team === 'azul');
    const vermelhos = roomPlayers.filter(p => p.team === 'vermelho');

    azuis.forEach((p, i) => {
        if (i === 0) setPos(p, 200, FIELD_H/2);
        else if (i === 1) setPos(p, 600, FIELD_H/2);
        else if (i === 2) setPos(p, 900, FIELD_H/2 - 200);
        else setPos(p, 900, FIELD_H/2 + 200);
    });

    vermelhos.forEach((p, i) => {
        if (i === 0) setPos(p, FIELD_W - 200, FIELD_H/2);
        else if (i === 1) setPos(p, FIELD_W - 600, FIELD_H/2);
        else if (i === 2) setPos(p, FIELD_W - 900, FIELD_H/2 - 200);
        else setPos(p, FIELD_W - 900, FIELD_H/2 + 200);
    });

    roomPlayers.forEach(p => {
        if(p.team === 'spec') setPos(p, -9999, -9999);
    });
}

function resolvePlayerCollisions() {
    for (let i = 0; i < roomPlayers.length; i++) {
        for (let j = i + 1; j < roomPlayers.length; j++) {
            let p1 = roomPlayers[i];
            let p2 = roomPlayers[j];

            if (p1.x < -1000 || p2.x < -1000) continue;

            let dx = p2.x - p1.x;
            let dy = p2.y - p1.y;
            let dist = Math.sqrt(dx * dx + dy * dy);
            let minDist = p1.r + p2.r;

            if (dist < minDist && dist > 0) {
                let overlap = minDist - dist;
                let moveX = (dx / dist) * (overlap / 2);
                let moveY = (dy / dist) * (overlap / 2);
                p1.x -= moveX; p1.y -= moveY;
                p2.x += moveX; p2.y += moveY;
            }
        }
    }
}

function triggerGoal(scorer) {
    playSound('goal');
    document.getElementById('goal-nick').innerText = scorer;
    document.getElementById('goal-container').style.display = 'block';
    
    const particleCount = graphicsLow ? 10 : 40;
    if(particles.length < 50) {
        for(let i=0; i<particleCount; i++) {
            particles.push({
                x: canvas.width/2, y: canvas.height/2,
                vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                life: 1.0, color: `hsl(${Math.random()*360}, 100%, 50%)`
            });
        }
    }

    setTimeout(() => {
        document.getElementById('goal-container').style.display = 'none';
        if(isHost) {
            isGoalProcess = false; 
            resetPositions();
            broadcastRoomState();
        }
    }, 2500);
}

function drawModernGoal(ctx, x, side) {
    const topY = FIELD_H/2 - GOAL_H_HALF;
    const botY = FIELD_H/2 + GOAL_H_HALF;
    const backX = x + (side * GOAL_DEPTH);
    
    ctx.lineJoin = "round";
    
    if(!graphicsLow) {
        ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=topY; i<=botY; i+=25) { ctx.moveTo(x, i); ctx.lineTo(backX, i); }
        for(let i=0; i<=GOAL_DEPTH; i+=25) { 
            let currentX = x + (side * i); ctx.moveTo(currentX, topY); ctx.lineTo(currentX, botY); 
        }
        ctx.stroke();
    }

    ctx.strokeStyle = "#fff"; ctx.lineWidth = graphicsLow ? 3 : 6;
    ctx.beginPath();
    ctx.moveTo(backX, topY); ctx.lineTo(backX, botY);
    ctx.moveTo(x, topY); ctx.lineTo(backX, topY);
    ctx.moveTo(x, botY); ctx.lineTo(backX, botY);
    ctx.stroke();
    
    ctx.fillStyle = "#eee";
    ctx.beginPath(); ctx.arc(x, topY, graphicsLow ? 6 : 10, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(x, botY, graphicsLow ? 6 : 10, 0, Math.PI*2); ctx.fill();
}

function checkPostCollision(entity) {
    const topPost = FIELD_H/2 - GOAL_H_HALF;
    const botPost = FIELD_H/2 + GOAL_H_HALF;
    const posts = [{x:0, y:topPost}, {x:0, y:botPost}, {x:FIELD_W, y:topPost}, {x:FIELD_W, y:botPost}];
    const walls = [
        {y: topPost, xStart: -GOAL_DEPTH, xEnd: 0}, {y: botPost, xStart: -GOAL_DEPTH, xEnd: 0},
        {y: topPost, xStart: FIELD_W, xEnd: FIELD_W + GOAL_DEPTH}, {y: botPost, xStart: FIELD_W, xEnd: FIELD_W + GOAL_DEPTH}
    ];
    walls.forEach(w => {
        if (entity.x >= Math.min(w.xStart, w.xEnd) - entity.r && entity.x <= Math.max(w.xStart, w.xEnd) + entity.r) {
            let distY = Math.abs(entity.y - w.y);
            if (distY < entity.r + 5) {
                if (entity.y < w.y) entity.y = w.y - (entity.r + 5); else entity.y = w.y + (entity.r + 5);
                if (entity === ball) entity.vy *= -0.5;
            }
        }
    });
    posts.forEach(p => {
        let dx = entity.x - p.x, dy = entity.y - p.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < entity.r + 20) { 
            let angle = Math.atan2(dy, dx);
            if(entity === ball) {
                playSound('post');
                entity.x = p.x + Math.cos(angle) * (entity.r + 21);
                entity.y = p.y + Math.sin(angle) * (entity.r + 21);
                entity.vx = Math.cos(angle) * 4.5; entity.vy = Math.sin(angle) * 4.5;
            } else {
                entity.x = p.x + Math.cos(angle) * (entity.r + 20);
                entity.y = p.y + Math.sin(angle) * (entity.r + 20);
            }
        }
    });
}

function processInputLocal() {
    let moveX = 0; let moveY = 0;
    if(keys.w) moveY = -1;
    if(keys.s) moveY = 1;
    if(keys.a) moveX = -1;
    if(keys.d) moveX = 1;

    let vx = 0, vy = 0;
    if(moveX !== 0 || moveY !== 0) {
        let angle = Math.atan2(moveY, moveX);
        vx = Math.cos(angle);
        vy = Math.sin(angle);
    } else {
        vx = Math.cos(joy.angle) * joy.force;
        vy = Math.sin(joy.angle) * joy.force;
    }
    
    if((vx !== 0 || vy !== 0 || kickRequest > 0) && isHost) {
        const me = roomPlayers.find(p => p.id === myPeerId);
        if(me) me.lastAction = Date.now();
    }
    
    return { vx: vx, vy: vy, kick: kickRequest };
}

function loop() {
    if(document.getElementById('lobby').style.display !== 'none') {
        requestAnimationFrame(loop);
        return; 
    }

    ctx.fillStyle = "#14532d"; 
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.restore();

    if(!isPaused) {
        const myInput = processInputLocal();
        if(!isHost && conn && conn.open) {
            conn.send({ type: 'INPUT', id: myData.id, input: myInput });
        }
        if(isHost) {
            const me = roomPlayers.find(p => p.id === myData.id);
            if(me) me.input = myInput;
            updateGameInfoDOM(timeLeft, score);
        }
        kickRequest = 0; 
    }

    // --- L√ìGICA DO HOST ---
    if(isHost && !isPaused) {
        roomPlayers.forEach(p => {
            if(!p.input) return;
            if(p.x < -1000) return;

            p.vx += p.input.vx * 0.8;
            p.vy += p.input.vy * 0.8;
            p.vx *= 0.88; p.vy *= 0.88;
            p.x += p.vx; p.y += p.vy;
            checkPostCollision(p);

            if(p.input.kick > 0) {
                 const dx = ball.x - p.x;
                 const dy = ball.y - p.y;
                 const dist = Math.sqrt(dx*dx + dy*dy);
                 if(dist < p.r + ball.r + 15) { 
                     ball.vx = (dx/dist)*p.input.kick; 
                     ball.vy = (dy/dist)*p.input.kick; 
                     playSound('kick');
                     lastTouchNick = p.nick; 
                 }
                 p.input.kick = 0; 
            }

            let dx = ball.x - p.x, dy = ball.y - p.y, dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < p.r + ball.r) { 
                let ang = Math.atan2(dy, dx), overlap = (p.r + ball.r) - dist;
                ball.x += Math.cos(ang) * overlap; ball.y += Math.sin(ang) * overlap;
                p.x -= Math.cos(ang) * (overlap * 0.5); p.y -= Math.sin(ang) * (overlap * 0.5);
                ball.vx += Math.cos(ang)*0.6; ball.vy += Math.sin(ang)*0.6;
                lastTouchNick = p.nick; 
            }
        });

        resolvePlayerCollisions();

        ball.x += ball.vx; ball.y += ball.vy; ball.vx *= 0.985; ball.vy *= 0.985;
        checkPostCollision(ball);
        if(ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.8; }
        if(ball.y > FIELD_H - ball.r) { ball.y = FIELD_H - ball.r; ball.vy *= -0.8; }
        if(ball.x < ball.r || ball.x > FIELD_W - ball.r) {
            let topPostY = FIELD_H/2 - GOAL_H_HALF, botPostY = FIELD_H/2 + GOAL_H_HALF;
            let inGoalY = (ball.y > topPostY + ball.r) && (ball.y < botPostY - ball.r);
            if(inGoalY) {
                if(!isGoalProcess) {
                    isGoalProcess = true;
                    if(ball.x < FIELD_W/2) score.verm++; else score.azul++;
                    broadcast({ type: 'GOAL_EVENT', scorer: lastTouchNick });
                    triggerGoal(lastTouchNick);
                }
                if(ball.x < -GOAL_DEPTH + ball.r) { ball.x = -GOAL_DEPTH + ball.r; ball.vx *= -0.5; }
                if(ball.x > FIELD_W + GOAL_DEPTH - ball.r) { ball.x = FIELD_W + GOAL_DEPTH - ball.r; ball.vx *= -0.5; }
            } else {
                if(ball.x < ball.r) { ball.x = ball.r; ball.vx *= -0.8; } else { ball.x = FIELD_W - ball.r; ball.vx *= -0.8; }
                if(Math.abs(ball.vx) > 2) playSound('kick');
            }
        }

        const now = Date.now();
        if(now - lastNetworkUpdate > networkUpdateRate) {
            // PAYLOAD OTIMIZADO: S√≥ envia ID, X, Y (Sem strings, sem nomes, sem times)
            broadcast({ 
                type: 'GT', // Game Tick
                p: roomPlayers.map(p => ({i:p.id, x:Math.round(p.x), y:Math.round(p.y)})),
                b: {x:Math.round(ball.x), y:Math.round(ball.y)},
                s: score,
                t: timeLeft
            });
            lastNetworkUpdate = now;
        }
    } 
    // --- L√ìGICA DO CLIENTE (INTERPOLA√á√ÉO MELHORADA) ---
    else if (!isHost && !isPaused) {
        // Fator de suaviza√ß√£o aumentado para compensar a falta de ordem nos pacotes
        const lerpFactor = 0.4; 
        
        ball.x += (ball.tx - ball.x) * lerpFactor;
        ball.y += (ball.ty - ball.y) * lerpFactor;

        roomPlayers.forEach(p => {
            if(p.tx !== undefined && p.x > -5000) {
                p.x += (p.tx - p.x) * lerpFactor;
                p.y += (p.ty - p.y) * lerpFactor;
            }
        });
    }

    if(!graphicsLow && particles.length > 0) {
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect((p.x|0), (p.y|0), 6, 6); 
            if(p.life <= 0) particles.splice(i, 1);
        }
        ctx.globalAlpha = 1.0;
    }

    ctx.save();
    ctx.translate(canvas.width/2 / ctx.getTransform().a, canvas.height/2 / ctx.getTransform().d); 
    ctx.scale(gameZoom, gameZoom);
    
    if(isEditing) {
        ctx.translate(-FIELD_W/2, -FIELD_H/2);
    } else {
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me && me.team && me.team !== 'spec' && me.x > -5000) {
             ctx.translate((-me.x|0), (-me.y|0));
        } else {
             ctx.translate((-ball.x|0), (-ball.y|0));
        }
    }

    ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = graphicsLow ? 2 : 5; 
    ctx.strokeRect(0, 0, FIELD_W, FIELD_H);
    ctx.beginPath(); ctx.moveTo(FIELD_W/2, 0); ctx.lineTo(FIELD_W/2, FIELD_H); ctx.stroke();
    ctx.beginPath(); ctx.arc(FIELD_W/2, FIELD_H/2, 130, 0, Math.PI*2); ctx.stroke();

    drawModernGoal(ctx, 0, -1); drawModernGoal(ctx, FIELD_W, 1);

    if(!graphicsLow) { ctx.shadowBlur = 15; ctx.shadowColor = "rgba(0,0,0,0.4)"; }
    
    ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc((ball.x|0), (ball.y|0), ball.r, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0; ctx.strokeStyle = "#111"; ctx.lineWidth = 2;
    
    roomPlayers.forEach(p => {
        if(p.x < -1000) return; 
        const px = p.x | 0; 
        const py = p.y | 0;

        ctx.fillStyle = p.team === 'azul' ? '#2563eb' : '#dc2626';
        if(!graphicsLow) { ctx.shadowBlur = 10; ctx.shadowColor = p.team === 'azul' ? '#2563eb' : '#dc2626'; }
        ctx.beginPath(); ctx.arc(px, py, p.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0; ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.stroke();
        
        ctx.fillStyle = "white"; ctx.font = "900 18px Arial"; ctx.textAlign = "center";
        ctx.fillText(p.nick, px, py - 40);
        if(p.isCaptain) ctx.fillText("üëë", px, py - 60);
        if(p.id === myData.id) {
            ctx.beginPath(); ctx.moveTo(px, py-30); ctx.lineTo(px-5, py-38); ctx.lineTo(px+5, py-38); ctx.fill();
        }
    });
    
    if(isPaused) {
        let cx = 0, cy = 0;
        const me = roomPlayers.find(p => p.id === myData.id);
        if(me && me.x > -5000) { cx = me.x|0; cy = me.y|0; } else { cx = ball.x|0; cy = ball.y|0; }
        ctx.save();
        ctx.shadowColor = "black"; ctx.lineWidth = 8; ctx.strokeStyle = "black";
        ctx.fillStyle = "#facc15"; ctx.font = "italic 900 60px sans-serif";
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.strokeText("JOGO PAUSADO", cx, cy);
        ctx.fillText("JOGO PAUSADO", cx, cy);
        ctx.restore();
    }
    ctx.restore();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
